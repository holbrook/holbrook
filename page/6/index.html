<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="心内求法">
<meta property="og:url" content="http://holbrook.github.io/page/6/index.html">
<meta property="og:site_name" content="心内求法">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="心内求法">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://holbrook.github.io/page/6/"/>





  <title>心内求法</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?16d951e9b49ded5f2e821a0e61d77797";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">心内求法</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Holbrook的个人博客</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://holbrook.github.io/2014/01/23/develop_a_fuse_webservice.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Holbrook">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="心内求法">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014/01/23/develop_a_fuse_webservice.html" itemprop="url">JBoss Fuse：开发和部署Web Service</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-01-23T00:00:00+08:00">
                2014-01-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/软件技术/" itemprop="url" rel="index">
                    <span itemprop="name">软件技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2014/01/23/develop_a_fuse_webservice.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2014/01/23/develop_a_fuse_webservice.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="快速开始"><a class="markdownIt-Anchor" href="#快速开始"></a> 快速开始</h1>
<p>因为<a href="/2014/01/20/about_fuse_esb.html#menuIndex1">Fuse的核心组成部分是ServiceMix</a>，<br>
所以“用Fuse开发WebService”也就是“用ServiceMix开发WebService”。</p>
<p>[ServiceMix提供了大量的开发工具(<a href="http://search.maven.org/#search%7Cga%7C1%7Corg.apache.servicemix.tooling" target="_blank" rel="noopener">http://search.maven.org/#search|ga|1|org.apache.servicemix.tooling</a>)，</p>
<p>其中<a href="http://search.maven.org/#search%7Cga%7C1%7Ca%3A%22servicemix-cxf-code-first-osgi-bundle%22" target="_blank" rel="noopener">servicemix-cxf-code-first-osgi-bundle</a>是用于开发“代码优先”的Web Service的一个<a href="http://maven.apache.org/guides/introduction/introduction-to-archetypes.html" target="_blank" rel="noopener">maven archetype</a>。可以快速创建一个demo:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mvn archetype:generate  \</span><br><span class="line"><span class="attribute">-DarchetypeGroupId</span>=org.apache.servicemix.tooling \</span><br><span class="line"><span class="attribute">-DarchetypeArtifactId</span>=servicemix-cxf-code-first-osgi-bundle \</span><br><span class="line"><span class="attribute">-DarchetypeVersion</span>=2013.01 \</span><br><span class="line"><span class="attribute">-DgroupId</span>=thinkinside.demo.fuse \</span><br><span class="line"><span class="attribute">-DartifactId</span>=webservice-demo \</span><br><span class="line"><span class="attribute">-Dversion</span>=1.0.0-SNAPSHOT</span><br></pre></td></tr></table></figure>
<p>会创建如下结构的一个工程：</p>
<p><img src="/images/fuse/webservice-demo-structure.png" alt="webservice工程目录结构"></p>
<p>从<code>pom.xml</code>来看，这是一个<a href="/2014/01/21/tycho_vs_maven_bundle_plugin.html">使用maven-bundle-plugin构建的OSGi bundle工程</a>。</p>
<h1 id="apache-cxf与spring"><a class="markdownIt-Anchor" href="#apache-cxf与spring"></a> Apache CXF与Spring</h1>
<p>上面的工程中包含了`META-INF/spring/beans.xml’文件:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="comment">&lt;!-- Generated by Apache ServiceMix Archetype --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xmlns:jaxws</span>=<span class="string">"http://cxf.apache.org/jaxws"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">"</span></span></span><br><span class="line"><span class="tag"><span class="string">      http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">      http://cxf.apache.org/jaxws http://cxf.apache.org/schemas/jaxws.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">      http://www.springframework.org/schema/osgi http://www.springframework.org/schema/osgi/spring-osgi.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">jaxws:endpoint</span> <span class="attr">id</span>=<span class="string">"HTTPEndpoint"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">implementor</span>=<span class="string">"thinkinside.demo.fuse.person.PersonImpl"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">address</span>=<span class="string">"/PersonServiceCF"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>说明这个bundle依赖<a href="/2014/01/20/about_fuse_esb.html#menuIndex5">ServiceMix中集成的Spring DM插件</a><br>
可见，该工程中使用了Spring DM。</p>
<p>之所以在ServiceMix中既有Apache Areis Blueprint，又有Spring DM，是因为有很多遗留系统是基于Srping的。比如，Apache CXF就专门提供了<a href="http://cxf.apache.org/docs/writing-a-service-with-spring.html" target="_blank" rel="noopener">使用Sping集成和发布WebService的机制</a>。</p>
<p>上面<code>beans.xml</code>中的<code>&lt;jaxws:endpoint&gt;</code>标签，就是由CXF提供的专门用于spring的schema中定义。</p>
<p>在ServiceMix中，CXF通过OSGi bundle: <code>cxf-bundle-compatible</code>被容器管理。</p>
<h1 id="部署到servicemix"><a class="markdownIt-Anchor" href="#部署到servicemix"></a> 部署到ServiceMix</h1>
<p>执行<code>mvn package</code>后，得到<code>webservice-demo-1.0.0-SNAPSHOT.jar</code>，这是一个OSGi bundle。可以将jar文件部署到</p>
<p><code>$SERVICEMIX_HOME/deploy/</code>目录中。正常情况下，bundle的依赖关系被满足，该bundle会被自动启动。<br>
此时访问<a href="http://localhost:8181/cxf" target="_blank" rel="noopener">http://localhost:8181/cxf</a>，应该能够在Apache CXF服务清单中看到<code>beans.xml</code>中定义的web service。</p>
<h1 id="从servicemix到fuse"><a class="markdownIt-Anchor" href="#从servicemix到fuse"></a> 从ServiceMix到Fuse</h1>
<p>上述的过程也适用于JBoss Fuse。</p>
<p>但是Fuse对ServiceMix进行了再次封装，需要使用Fuse对应的版本。比如，<code>servicemix-cxf-code-first-osgi-bundle</code>的版本可能要使用<code>2012.01.0.redhat-60024</code>这样的“Fuse版本号”，否则在部署到Fuse是可能会发生版本不匹配的问题。</p>
<p>Fuse提供了一个maven仓库，专门提供这种定制版本的组件，需要在maven中配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>fusesource<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://repo.fusesource.com/nexus/content/groups/public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">releases</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">releases</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://holbrook.github.io/2014/01/22/osgi_blueprint_container.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Holbrook">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="心内求法">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014/01/22/osgi_blueprint_container.html" itemprop="url">Blueprint：OSGi的依赖注入(DI)容器</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-01-22T00:00:00+08:00">
                2014-01-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/软件技术/" itemprop="url" rel="index">
                    <span itemprop="name">软件技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2014/01/22/osgi_blueprint_container.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2014/01/22/osgi_blueprint_container.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>曾几何时，你在Spring和OSGi之间摇摆不定；曾几何时，你对SpringDM感到迷惑不解。你是否向往OSGi的动态特性，又为遗留代码（尤其是基于Spring的代码）感到不舍？现在，这些都不再是问题！</p>
<p>曾几何时，你在Spring和OSGi之间摇摆不定；曾几何时，你对SpringDM感到迷惑不解。<br>
你是否向往OSGi的动态特性，又为遗留代码（尤其是基于Spring的代码）感到不舍？</p>
<p>现在，这些都不再是问题！</p>
<p>在<a href="http://www.osgi.org/Release4/HomePage" target="_blank" rel="noopener">OSGi Service Platform Release 4</a> V4.2中，<br>
提到了很多的<a href="http://www.osgi.org/download/r4v42/r4.enterprise.pdf" target="_blank" rel="noopener">企业级规范(Enterprise Specification)</a>，<br>
其中包括了规范121：Blueprint容器规范(Container Specification)。</p>
<p>Buleprint容器规范规定了一个OSGi容器(不是OSGi rumtime)的方方面面：</p>
<img src="/2014/01/22/osgi_blueprint_container/Blueprint_Container_Specification_list.png">
<p>Buleprint(或者说，OSGi Enterprise)目前有两个主要的实现：<a href="http://www.eclipse.org/gemini/" target="_blank" rel="noopener">Eclipse Gemini</a>和<a href="http://aries.apache.org/" target="_blank" rel="noopener">Apache Aries</a>。</p>
<p>其中Gemini的代码最初来自Spring DM，其实Blueprint规范的最早版本也来自Spring；而Aries已经用在Apache的众多企业级产品中。</p>
<p>在本文中，使用Aries Blueprint。</p>
<h1 id="依赖注入"><a class="markdownIt-Anchor" href="#依赖注入"></a> 依赖注入</h1>
<p>Blueprint Container 规范为 OSGi 定义了一个 依赖性注入（DI,Dependency Injection）框架，可以处理OSGi 的动态特性。<br>
与<a href="/2014/01/12/dependency_injection_in_e4.html#menuIndex2">OSGi服务</a>或<a href="/2014/01/12/dependency_injection_in_e4.html#menuIndex3">OSGi Declarative Service</a>，不同，Blueprint依赖注入可以处理POJO对象的装配，使得POJO能够在OSGi中跨bundle访问。</p>
<p>这与<a href="http://thinkinside.tk/2013/12/31/jsr330.html" target="_blank" rel="noopener">JSR330:Java依赖注入规范</a>很像，是该规范在OSGi环境下的扩展。<br>
这也就是Spring DM(Spring Dynamic Modules)干的事情。实际上，Buleprint容器规范最初就来自于Spring，<br>
而其Gemini实现更是来自SpringDM的捐赠。</p>
<p>无奈，如今<a href="http://www.infoq.com/cn/news/2012/11/spring-osgi-gradle" target="_blank" rel="noopener">Spring已经宣布放弃OSGi</a>正所谓造化弄人，让人唏嘘不已。</p>
<h1 id="blueprint-xml"><a class="markdownIt-Anchor" href="#blueprint-xml"></a> Blueprint XML</h1>
<p>Blueprint使用XML文件描述装配关系，下面是一个例子：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span> standalone=<span class="string">"no"</span><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="tag">&lt;<span class="name">blueprint</span> <span class="attr">xmlns</span>=<span class="string">"http://www.osgi.org/xmlns/blueprint/v1.0.0"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- Bean Manager Examples --&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"accountOne"</span> <span class="attr">class</span>=<span class="string">"org.apache.aries.samples.Account"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">argument</span> <span class="attr">value</span>=<span class="string">"1"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"description"</span> <span class="attr">value</span>=<span class="string">"#1 account"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"accountTwo"</span> <span class="attr">class</span>=<span class="string">"org.apache.aries.samples.StaticAccountFactory"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">factory-method</span>=<span class="string">"createAccount"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">argument</span> <span class="attr">value</span>=<span class="string">"2"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"description"</span> <span class="attr">value</span>=<span class="string">"#2 account"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"accountFactory"</span> <span class="attr">class</span>=<span class="string">"org.apache.aries.samples.AccountFactory"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">argument</span> <span class="attr">value</span>=<span class="string">"account factory"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"accountThree"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">factory-ref</span>=<span class="string">"accountFactory"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">factory-method</span>=<span class="string">"createAccount"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">argument</span> <span class="attr">value</span>=<span class="string">"3"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"description"</span> <span class="attr">value</span>=<span class="string">"#3 account"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"prototypeAccount"</span> <span class="attr">class</span>=<span class="string">"org.apache.aries.samples.Account"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">scope</span>=<span class="string">"prototype"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">argument</span> <span class="attr">value</span>=<span class="string">"4"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"singletonAccount"</span> <span class="attr">class</span>=<span class="string">"org.apache.aries.samples.Account"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">scope</span>=<span class="string">"singleton"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">argument</span> <span class="attr">value</span>=<span class="string">"5"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"accountFour"</span> <span class="attr">class</span>=<span class="string">"org.apache.aries.samples.Account"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">init-method</span>=<span class="string">"init"</span> <span class="attr">destroy-method</span>=<span class="string">"destroy"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">argument</span> <span class="attr">value</span>=<span class="string">"6"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"description"</span> <span class="attr">value</span>=<span class="string">"#6 account"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- Service Manager Examples --&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"myAccount"</span> <span class="attr">class</span>=<span class="string">"org.apache.aries.samples.MyAccount"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">argument</span> <span class="attr">value</span>=<span class="string">"7"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"description"</span> <span class="attr">value</span>=<span class="string">"MyAccount"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">service</span> <span class="attr">id</span>=<span class="string">"serviceOne"</span> <span class="attr">ref</span>=<span class="string">"myAccount"</span> <span class="attr">interface</span>=<span class="string">"java.io.Serializable"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">service</span> <span class="attr">id</span>=<span class="string">"serviceTwo"</span> <span class="attr">ref</span>=<span class="string">"myAccount"</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">interfaces</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">value</span>&gt;</span>java.io.Serializable<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">interfaces</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">service</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">service</span> <span class="attr">id</span>=<span class="string">"serviceThree"</span> <span class="attr">ref</span>=<span class="string">"myAccount"</span> <span class="attr">auto-export</span>=<span class="string">"all-classes"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">service</span> <span class="attr">id</span>=<span class="string">"serviceFour"</span> <span class="attr">ref</span>=<span class="string">"myAccount"</span> <span class="attr">auto-export</span>=<span class="string">"all-classes"</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">service-properties</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"mode"</span> <span class="attr">value</span>=<span class="string">"shared"</span>/&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"active"</span>&gt;</span></span><br><span class="line">             <span class="tag">&lt;<span class="name">value</span> <span class="attr">type</span>=<span class="string">"java.lang.Boolean"</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">service-properties</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">service</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">service</span> <span class="attr">id</span>=<span class="string">"serviceFive"</span> <span class="attr">ref</span>=<span class="string">"myAccount"</span> <span class="attr">auto-export</span>=<span class="string">"all-classes"</span> <span class="attr">ranking</span>=<span class="string">"3"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">service</span> <span class="attr">id</span>=<span class="string">"serviceSix"</span> <span class="attr">ref</span>=<span class="string">"myAccount"</span> <span class="attr">auto-export</span>=<span class="string">"all-classes"</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">registration-listener</span></span></span><br><span class="line"><span class="tag">             <span class="attr">registration-method</span>=<span class="string">"register"</span> <span class="attr">unregistration-method</span>=<span class="string">"unregister"</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.apache.aries.samples.RegistrationListener"</span>/&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">registration-listener</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">service</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- Service Reference Manager Examples --&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">reference-list</span> <span class="attr">id</span>=<span class="string">"serviceReferenceListTwo"</span> <span class="attr">interface</span>=<span class="string">"java.io.Serializable"</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">availability</span>=<span class="string">"optional"</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">reference-listener</span></span></span><br><span class="line"><span class="tag">             <span class="attr">bind-method</span>=<span class="string">"bind"</span> <span class="attr">unbind-method</span>=<span class="string">"unbind"</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.apache.aries.samples.ReferenceListener"</span>/&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">reference-listener</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">reference-list</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- Environmental Manager Example --&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"accountManagerOne"</span> <span class="attr">class</span>=<span class="string">"org.apache.aries.samples.AccountManager"</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"managerBundle"</span> <span class="attr">ref</span>=<span class="string">"blueprintBundle"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- Object Values Examples --&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"accountManagerTwo"</span> <span class="attr">class</span>=<span class="string">"org.apache.aries.samples.AccountManager"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"managedAccount"</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">ref</span> <span class="attr">component-id</span>=<span class="string">"accountOne"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"accountManagerThree"</span> <span class="attr">class</span>=<span class="string">"org.apache.aries.samples.AccountManager"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"managedAccount"</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.apache.aries.samples.Account"</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">argument</span> <span class="attr">value</span>=<span class="string">"10"</span>/&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"description"</span> <span class="attr">value</span>=<span class="string">"Inlined Account"</span>/&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"accountManagerFour"</span> <span class="attr">class</span>=<span class="string">"org.apache.aries.samples.AccountManager"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"accountNumbers"</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">value</span>&gt;</span>123<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">value</span>&gt;</span>456<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">value</span>&gt;</span>789<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">blueprint</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>可以看出，这个文件与Spring的配置文件非常类似。</p>
<p>Blueprint XML中可以标记<code>bean</code>，<code>service</code>、<code>reference-list</code>等元素，用于bean管理、service管理和service引用管理。</p>
<img src="/2014/01/22/osgi_blueprint_container/blueprint_config.png">
<ul>
<li>
<p>Bean管理</p>
<p>通过<code>&lt;bean&gt;</code>标签定义Bean，容器可以创建bean、设置属性。bean的创建可以基于构造函数、静态工厂或工厂方法；属性可以是基本类型，也可以引用其他的bean。可以设置bean的scope为singleton或prototype。</p>
</li>
<li>
<p>Service管理</p>
<p>bean只能在当前bundle中使用。要跨bundle引用，必须定义服务。服务可以依赖bean或其他服务。</p>
<p>服务管理用于在OSGi服务注册表中注册服务。容器会根据服务的依赖关系是否满足，自动注册或注销服务。</p>
</li>
<li>
<p>Service引用管理</p>
<p>通过<code>&lt;reference&gt;</code>和<code>&lt;reference-list&gt;</code>标签可以引用其他bundle中发布的服务。两个标签分布用于引用单个服务和引用服务列表。</p>
</li>
</ul>
<p>一个bundle可以有一个或多个xml配置，通常位于<code>OSGI-INF/blueprint/</code>目录下，也可以在<code>META-INF/MANIFEST.MF</code>文件中通过<br>
<code>Bundle-Blueprint</code>属性进行指定。</p>
<p>更多关于Blueprint XML配置的内容和例子，可以参考<a href="http://aries.apache.org/documentation/tutorials/blueprinthelloworldtutorial.html" target="_blank" rel="noopener">Apache Aries官方的例子</a>，以及<a href="https://www.ibm.com/developerworks/cn/opensource/os-osgiblueprint/" target="_blank" rel="noopener">developerWorks上的这篇文章</a></p>
<h1 id="工作原理"><a class="markdownIt-Anchor" href="#工作原理"></a> 工作原理</h1>
<p>Blueprint Container 使用扩展器（extender）模式，监视OSGi框架中的bundle的状态。当新的bundle被激活时，<br>
Blueprint根据该bundle是否有Blueprint XML配置文件判断是否需要容器进行处理。</p>
<p>处理的过程是为该bundle创建一个容器，通过容器解析XML文件，并将组件装配到一起。如果bundle中的服务依赖得到满足，容器还会调用<a href="/2014/01/12/dependency_injection_in_e4.html#menuIndex3">OSGi DS</a>发布服务。</p>
<p>在停止bundle时，也会进行相反的销毁过程。</p>
<h1 id="在eclipse中运行和调试"><a class="markdownIt-Anchor" href="#在eclipse中运行和调试"></a> 在Eclipse中运行和调试</h1>
<p>可以在前面<a href="/2014/01/21/tycho_vs_maven_bundle_plugin.html#menuIndex2">通过maven手工创建Felix运行环境</a>的基础上，<br>
增加Blueprint需要的bundle:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- for aries blueprint --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactItem</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.aries.blueprint<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>org.apache.aries.blueprint<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">artifactItem</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactItem</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.aries.proxy<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>org.apache.aries.proxy<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">artifactItem</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactItem</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.aries<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>org.apache.aries.util<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">artifactItem</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactItem</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.felix<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>org.apache.felix.configadmin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">artifactItem</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactItem</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.ops4j.pax.logging<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>pax-logging-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">artifactItem</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactItem</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.ops4j.pax.logging<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>pax-logging-service<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">artifactItem</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h1 id="使用apache-felix-karaf"><a class="markdownIt-Anchor" href="#使用apache-felix-karaf"></a> 使用Apache Felix Karaf</h1>
<p>自己搭建的Felix+Blueprint环境功能很有限，比如缺失了很多必要的基础组件和管理功能。更好的选择是使用<a href="http://karaf.apache.org/" target="_blank" rel="noopener">Apache Felix Karaf</a>。</p>
<p>Karaf在Felix和Blueprint的基础上，还增加了一些插件，以提供认证和登录、热部署、动态配置、控制台以及一些管理功能。</p>
<p>更贴心的是，Karaf还提供了Eclipse插件：<a href="http://karaf.apache.org/index/subprojects/eik.html" target="_blank" rel="noopener">Eclipse Integration for Karaf (EIK)</a>，从而可以：</p>
<ul>
<li>Custom Eclipse perspective for Apache Karaf development:
<ul>
<li>places valuable Karaf runtime information in one location</li>
</ul>
</li>
<li>Apache Karaf installation management in your workspace:
<ul>
<li>Karaf installations are managed as workspace projects giving the developer visibility in to the runtime</li>
<li>each Karaf installation is automatically synchronized with your workspace, including additional bundles, configuration files</li>
</ul>
</li>
<li>Run and debug Karaf installations with a single Eclipse Launcher:
<ul>
<li>the launch configuration allows developers to fine tune how Karaf will launch</li>
</ul>
</li>
<li>Automatic deployment of workspace plugin projects:
<ul>
<li>create plugin-projects and have them deployed automatically</li>
</ul>
</li>
<li>Advanced instrumentation of the running Karaf instance:
<ul>
<li>watch bundles deploy in real time and examine the OSGi service registry from within the Eclipse IDE</li>
</ul>
</li>
<li>Access Eclipse platform IDE plugins from within a running Karaf instance:
<ul>
<li>all Eclipse plugins are presented as an OBR</li>
</ul>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://holbrook.github.io/2014/01/21/tycho_vs_maven_bundle_plugin.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Holbrook">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="心内求法">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014/01/21/tycho_vs_maven_bundle_plugin.html" itemprop="url">OSGi构建工具：Tycho还是Maven-Bundle-Plugin？</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-01-21T00:00:00+08:00">
                2014-01-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/软件技术/" itemprop="url" rel="index">
                    <span itemprop="name">软件技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2014/01/21/tycho_vs_maven_bundle_plugin.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2014/01/21/tycho_vs_maven_bundle_plugin.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="tycho与maven-bundle-plugin的对比"><a class="markdownIt-Anchor" href="#tycho与maven-bundle-plugin的对比"></a> Tycho与Maven-Bundle-Plugin的对比</h1>
<p>Maven与OSGi天生就是冤家：Maven通过<code>pom.xml</code>描述一个产物的全部，而OSGi将这项工作交给了<code>MANIFEST.MF</code>。</p>
<p>如果仅仅是一些定义信息还好说，但是Maven和OSGi都希望能够描述产物的依赖关系，在使用Maven开发OSGi bundle的时候，就导致了一个问题：</p>
<p>依赖关系到底是在<code>pom.xml</code>中描述，还是在<code>MANIFEST.MF</code>中描述？</p>
<p><a href="/2014/01/08/build_osgi_bundle_with_tycho_maven_plugin.html">前面提到的Tycho</a>的思路是由<code>MANIFEST.MF</code>自行管理bundle的依赖关系，<code>pom.xml</code>只记录使用maven进行构建时需要的信息，比如maven工程的父子关系、打包时需要的bundle仓库及要发布的目标平台等。</p>
<p>Tycho的这种机制对Eclipse IDE比较友好，在开发期间完全使用IDE的机制进行开发和调试，只有在打包部署时才依赖maven。</p>
<p><a href="http://felix.apache.org/site/apache-felix-maven-bundle-plugin-bnd.html" target="_blank" rel="noopener">Apache Felix Maven-Bundle-Plugin</a><br>
则使用另一套机制：使用Maven-Bundle-Plugin，在开发时可以没有<code>MANIFEST.MF</code>文件！Maven-Bundle-Plugin在<code>pom.xml</code>中复制了一套<code>MANIFEST.MF</code>的元数据，完全可以通过<code>pom.xml</code>文件中的定义生成出完整的<code>MANIFEST.MF</code>文件。</p>
<p>Maven-Bundle-Plugin的这种机制使得工程完全的”maven化”，更适合传统非OSGi开发人员的使用习惯。但是无法很好的利用IDE的开发和调试功能，比如，你可能需要自己搭建一个运行环境从IDE中调用。</p>
<p>两种方式可谓各有千秋。但是Tycho明显基于Equniox和Eclipse，比如，Tycho可以配置Eclipse p2站点作为bundle库。如果要使用Tycho开发和调试Felix，需要搭建一个Eclipse风格的p2站点，将Felix runtime和需要的各种bundle都放到该站点中并发布，然后<a href="/2014/01/08/build_osgi_bundle_with_tycho_maven_plugin.html#menuIndex2">在Tycho中引用该站点</a>。更详细的说明可以参考<a href="http://vzurczak.wordpress.com/2013/02/27/a-target-platform-based-on-apache-felix/" target="_blank" rel="noopener">这里</a>。</p>
<p>而Felix Maven-Bundle-Plugin对于各种OSGi runtime的支持是相同的，由于完全基于maven，使用任何IDE开发bundle的效果都差不多。通常，Felix系的平台，如Karaf、Geronimo、Camel、ServiceMix、Fuse等，其例子都是使用Maven-Bundle-Plugin构建的。</p>
<p>由于<a href="/2014/01/08/build_osgi_bundle_with_tycho_maven_plugin.html">前文已经说明了如何用Tycho开发OSGi</a>，下面只给出使用Maven-Bundle-Plugin的例子。</p>
<h1 id="maven-bundle-plugin的pom例子"><a class="markdownIt-Anchor" href="#maven-bundle-plugin的pom例子"></a> Maven-Bundle-Plugin的pom例子</h1>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span></span><br><span class="line"><span class="xml">xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>thinkinside.demo.osgi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>simple-bundle<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span></span><br><span class="line"><span class="xml">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.felix<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="xml">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-bundle-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="xml">			<span class="tag">&lt;<span class="name">executions</span>&gt;</span></span></span><br><span class="line"><span class="xml">				<span class="tag">&lt;<span class="name">execution</span>&gt;</span></span></span><br><span class="line"><span class="xml">					<span class="tag">&lt;<span class="name">id</span>&gt;</span>generate-resources<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span></span><br><span class="line"><span class="xml">					<span class="tag">&lt;<span class="name">goals</span>&gt;</span></span></span><br><span class="line"><span class="xml">						<span class="tag">&lt;<span class="name">goal</span>&gt;</span>manifest<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span></span><br><span class="line"><span class="xml">					<span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">					<span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span></span><br><span class="line"><span class="xml">						<span class="tag">&lt;<span class="name">instructions</span>&gt;</span></span></span><br><span class="line"><span class="xml">							<span class="tag">&lt;<span class="name">Bundle-Name</span>&gt;</span>$</span><span class="template-variable">&#123;project.name&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">Bundle-Name</span>&gt;</span></span></span><br><span class="line"><span class="xml">							<span class="tag">&lt;<span class="name">Bundle-SymbolicName</span>&gt;</span>$</span><span class="template-variable">&#123;project.artifactId&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">Bundle-SymbolicName</span>&gt;</span></span></span><br><span class="line"><span class="xml">							<span class="tag">&lt;<span class="name">Bundle-Activator</span>&gt;</span>test.bundle.internal.Activator<span class="tag">&lt;/<span class="name">Bundle-Activator</span>&gt;</span></span></span><br><span class="line"><span class="xml">							<span class="tag">&lt;<span class="name">Export-Package</span>&gt;</span>***<span class="tag">&lt;/<span class="name">Export-Package</span>&gt;</span></span></span><br><span class="line"><span class="xml">           					<span class="tag">&lt;<span class="name">Import-Package</span>&gt;</span>***<span class="tag">&lt;/<span class="name">Import-Package</span>&gt;</span></span></span><br><span class="line"><span class="xml">           					<span class="tag">&lt;<span class="name">Private-Package</span>&gt;</span>***<span class="tag">&lt;/<span class="name">Private-Package</span>&gt;</span></span></span><br><span class="line"><span class="xml">           				<span class="tag">&lt;/<span class="name">instructions</span>&gt;</span></span></span><br><span class="line"><span class="xml">					<span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span></span><br><span class="line"><span class="xml">				<span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span></span><br><span class="line"><span class="xml">			<span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span></span><br><span class="line"><span class="xml">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="xml">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-jar-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="xml">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="xml">			<span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span></span><br><span class="line"><span class="xml">				<span class="tag">&lt;<span class="name">archive</span>&gt;</span></span></span><br><span class="line"><span class="xml">					<span class="tag">&lt;<span class="name">manifestFile</span>&gt;</span>$</span><span class="template-variable">&#123;project.build.outputDirectory&#125;</span><span class="xml">/META-INF/MANIFEST.MF<span class="tag">&lt;/<span class="name">manifestFile</span>&gt;</span></span></span><br><span class="line"><span class="xml">				<span class="tag">&lt;/<span class="name">archive</span>&gt;</span></span></span><br><span class="line"><span class="xml">			<span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.felix<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>org.osgi.core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>使用Maven-Bundle-Plugin构建bundle，就是构建一个简单的jar。不同之处在于：要通过pom.xml中的信息生成符合OSGi要求的<code>MANIFEST.MF</code>文件并打包到jar中。这通过两个插件来完成：</p>
<ul>
<li>
<p>org.apache.felix:maven-bundle-plugin</p>
<p>在项目生命周期的&quot;generate-resources&quot;阶段，根据<code>&lt;instructions&gt;</code>标签内定义的信息生成<code>MANIFEST.MF</code>文件。这里可以配置OSGi所需要的全部元数据。</p>
</li>
<li>
<p>org.apache.maven.plugins:maven-jar-plugin</p>
<p>配置其在打包是使用前面生成的<code>MANIFEST.MF</code>文件</p>
</li>
</ul>
<p>由于OSGi bundle通常会使用OSGi API，这里添加了org.apache.felix:org.osgi.core的依赖。当然也可以换成其他的OSGi运行时，比如Equinox。</p>
<p>此时，使用<code>mvn package</code>生成的jar包中，<code>MANIFEST.MF</code>文件内已经添加了配置好的bundle信息。</p>
<p>当然，使用<a href="http://svn.apache.org/repos/asf/felix/releases/maven-bundle-plugin-2.3.7/doc/site/index.html" target="_blank" rel="noopener">maven-bundle-plugin的目标(Goals)</a><br>
可以进行更细致的控制。</p>
<h1 id="在eclipse中运行和调试"><a class="markdownIt-Anchor" href="#在eclipse中运行和调试"></a> 在Eclipse中运行和调试</h1>
<p>本来，传说中的<a href="http://wiki.ops4j.org/confluence/display/ops4j/Pax%20Cursor" target="_blank" rel="noopener">Pax Cursor</a>可以在Eclipse中基于各种OSGi runtime运行和调试bundle，但是天朝的网络中似乎不存在<code>ops4j.org</code>这个域名。</p>
<p>好在我们可用一个Java Project的方式建立起Felix的环境，通过Eclipse对bundle进行运行和调试。<br>
由于<a href="http://felix.apache.org/site/integrating-felix-with-eclipse.html" target="_blank" rel="noopener">这里</a>有非常详细的说明，故不再赘述。</p>
<p>其实，我们还可以基于maven构建，而不是使用Java Project的方式。使用maven的好处是这种方法可以用于任何支持maven的IDE。</p>
<p>Felix runtime的主要内容包括：</p>
<img src="/2014/01/21/tycho_vs_maven_bundle_plugin/felix-tree.png">
<p>其中：</p>
<ul>
<li>bin/felix.jar  启动的jar, MainClass是<code>org.apache.felix.main.Main</code></li>
<li>bundle/	存放可用的bundle，Felix runtime中内置了4个必需的bundle</li>
<li>conf/conf.properties 启动配置。类似于Eclipse的<code>configuration/config.ini</code>。Felix配置项可以参考<a href="http://felix.apache.org/site/apache-felix-framework-configuration-properties.html" target="_blank" rel="noopener">官方网站中的内容</a></li>
</ul>
<p>知道了Felix runtime的构成，就可以用maven构建出相同的结构，并插入到项目周期的适当位置。pom如下：</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span></span><br><span class="line"><span class="xml">xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>thinkinside.demo.fuse<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>felix-launcher<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">name</span>&gt;</span>Felix Launcher<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">felix.bundlerepository.version</span>&gt;</span>1.6.4<span class="tag">&lt;/<span class="name">felix.bundlerepository.version</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">felix.gogo.version</span>&gt;</span>0.10.0<span class="tag">&lt;/<span class="name">felix.gogo.version</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">felix.framework.version</span>&gt;</span>4.2.1<span class="tag">&lt;/<span class="name">felix.framework.version</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span></span><br><span class="line"><span class="xml">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-clean-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="xml">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="xml">			<span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span></span><br><span class="line"><span class="xml">				<span class="tag">&lt;<span class="name">filesets</span>&gt;</span></span></span><br><span class="line"><span class="xml">					<span class="tag">&lt;<span class="name">fileset</span>&gt;</span></span></span><br><span class="line"><span class="xml">						<span class="tag">&lt;<span class="name">directory</span>&gt;</span>bundle<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span></span><br><span class="line"><span class="xml">					<span class="tag">&lt;/<span class="name">fileset</span>&gt;</span></span></span><br><span class="line"><span class="xml">				<span class="tag">&lt;/<span class="name">filesets</span>&gt;</span></span></span><br><span class="line"><span class="xml">			<span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span></span><br><span class="line"><span class="xml">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="xml">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-dependency-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="xml">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="xml">			<span class="tag">&lt;<span class="name">executions</span>&gt;</span></span></span><br><span class="line"><span class="xml">				<span class="tag">&lt;<span class="name">execution</span>&gt;</span></span></span><br><span class="line"><span class="xml">					<span class="tag">&lt;<span class="name">id</span>&gt;</span>copy<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span></span><br><span class="line"><span class="xml">					<span class="tag">&lt;<span class="name">phase</span>&gt;</span>generate-resources<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span></span><br><span class="line"><span class="xml">					<span class="tag">&lt;<span class="name">goals</span>&gt;</span></span></span><br><span class="line"><span class="xml">						<span class="tag">&lt;<span class="name">goal</span>&gt;</span>copy<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span></span><br><span class="line"><span class="xml">					<span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span></span><br><span class="line"><span class="xml">					<span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span></span><br><span class="line"><span class="xml">						<span class="tag">&lt;<span class="name">artifactItems</span>&gt;</span></span></span><br><span class="line"><span class="xml">							<span class="tag">&lt;<span class="name">artifactItem</span>&gt;</span></span></span><br><span class="line"><span class="xml">								<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.felix<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="xml">								<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>org.apache.felix.gogo.command<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="xml">								<span class="tag">&lt;<span class="name">version</span>&gt;</span>$</span><span class="template-variable">&#123;felix.gogo.version&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="xml">							<span class="tag">&lt;/<span class="name">artifactItem</span>&gt;</span></span></span><br><span class="line"><span class="xml">							<span class="tag">&lt;<span class="name">artifactItem</span>&gt;</span></span></span><br><span class="line"><span class="xml">								<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.felix<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="xml">								<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>org.apache.felix.gogo.runtime<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="xml">								<span class="tag">&lt;<span class="name">version</span>&gt;</span>$</span><span class="template-variable">&#123;felix.gogo.version&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="xml">							<span class="tag">&lt;/<span class="name">artifactItem</span>&gt;</span></span></span><br><span class="line"><span class="xml">							<span class="tag">&lt;<span class="name">artifactItem</span>&gt;</span></span></span><br><span class="line"><span class="xml">								<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.felix<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="xml">								<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>org.apache.felix.gogo.shell<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="xml">								<span class="tag">&lt;<span class="name">version</span>&gt;</span>$</span><span class="template-variable">&#123;felix.gogo.version&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="xml">							<span class="tag">&lt;/<span class="name">artifactItem</span>&gt;</span></span></span><br><span class="line"><span class="xml">							<span class="tag">&lt;<span class="name">artifactItem</span>&gt;</span></span></span><br><span class="line"><span class="xml">								<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.osgi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="xml">								<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>org.osgi.compendium<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="xml">								<span class="tag">&lt;<span class="name">version</span>&gt;</span>4.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="xml">							<span class="tag">&lt;/<span class="name">artifactItem</span>&gt;</span></span></span><br><span class="line"><span class="xml">						<span class="tag">&lt;/<span class="name">artifactItems</span>&gt;</span></span></span><br><span class="line"><span class="xml">						<span class="tag">&lt;<span class="name">outputDirectory</span>&gt;</span>bundle<span class="tag">&lt;/<span class="name">outputDirectory</span>&gt;</span></span></span><br><span class="line"><span class="xml">					<span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span></span><br><span class="line"><span class="xml">				<span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span></span><br><span class="line"><span class="xml">			<span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.felix<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>org.apache.felix.main<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>$</span><span class="template-variable">&#123;felix.framework.version&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.ops4j.pax.url<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>pax-url-assembly<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.6.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>该pom在标准的生命周期中增加了两项工作：</p>
<ul>
<li>在<code>generate-resources</code>阶段，创建bundle文件夹，复制必需的4个bundle</li>
<li>在<code>clean</code>阶段，清除bundle文件夹</li>
</ul>
<p>最后，还需要一个配置文件。在工程目录建立<code>/conf/config.properties</code>文件，并进行基本配置：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">felix<span class="selector-class">.auto</span><span class="selector-class">.deploy</span><span class="selector-class">.action</span>=install,start</span><br><span class="line">felix<span class="selector-class">.log</span><span class="selector-class">.level</span>=<span class="number">1</span></span><br><span class="line"></span><br><span class="line">org<span class="selector-class">.osgi</span><span class="selector-class">.framework</span><span class="selector-class">.storage</span><span class="selector-class">.clean</span>=onFirstInit</span><br></pre></td></tr></table></figure>
<p>配置完成了，先执行<code>mvn compile</code>生成需要的资源。此时使用命令<code>mvn exec:java -Dexec.mainClass=&quot;org.apache.felix.main.Main&quot;</code>即可以启动Felix runtime：</p>
<img src="/2014/01/21/tycho_vs_maven_bundle_plugin/felix_launch_from_maven.png">
<p>在Eclipse中，将这个工程作为<code>Java Application</code>运行，选择<code>org.apache.felix.main.Main</code>作为Main Class，就可以进行运行和调试。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://holbrook.github.io/2014/01/20/about_fuse_esb.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Holbrook">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="心内求法">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014/01/20/about_fuse_esb.html" itemprop="url">JBOSS FUSE:你必须知道的那些事</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-01-20T00:00:00+08:00">
                2014-01-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/软件技术/" itemprop="url" rel="index">
                    <span itemprop="name">软件技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2014/01/20/about_fuse_esb.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2014/01/20/about_fuse_esb.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <img src="/2014/01/20/about_fuse_esb/about_fuse.png">
<h1 id="jboss-fuse企业级esb"><a class="markdownIt-Anchor" href="#jboss-fuse企业级esb"></a> JBoss Fuse：企业级ESB</h1>
<p>我没写错，就是“企业级ESB”。尽管“ESB”是“企业服务总线“的缩写，但确实有些”所谓的ESB“并不具备企业级特性。</p>
<p>比如MuleCE，甚至MuleEE。</p>
<p><a href="http://www.jboss.org/products/fuse" target="_blank" rel="noopener">JBoss Fuse</a>具备了一个企业级平台所需要的特性：</p>

<p>除了实现基本的ESB功能外，JBoss Fuse还提供了IDE、管理和监控、集群支持等特性。这是一个产品进入企业级领域不可或缺的特性。</p>
<p>与Oracle Fusion、Mule ESB、Talend Unified Platform、WSO2 Platform等一样，JBoss Fuse也是一款商业的ESB产品。</p>
<p>JBoss Fuse由大量成熟的开源软件组合而成，包括但不仅限于：</p>
<ul>
<li>JBoss Fuse
<ul>
<li>Apache ServiceMix
<ul>
<li>Apache CXF</li>
<li>Apache Camel</li>
<li>Apache ActiveMQ</li>
<li>SpringDM</li>
</ul>
<ul>
<li>Karaf</li>
</ul>
<ul>
<li>BluePrint</li>
</ul>
</li>
<li>Fuse Fabric</li>
<li>HawtIO</li>
</ul>
</li>
</ul>
<p>可以说，Fuse使用的这些开源软件是历史的选择，经过长达8年的时间，融合了最广泛使用的同类产品，最终成为一个整体的ESB平台：</p>
<img src="/2014/01/20/about_fuse_esb/history.png">
<h1 id="apache-servicemix"><a class="markdownIt-Anchor" href="#apache-servicemix"></a> Apache ServiceMix</h1>
<p>尽管JBoss Fuse官方有意无意的避免提及ServiceMix，比如这张图：</p>
<img src="/2014/01/20/about_fuse_esb/fuse.png">
<p>和这段文字：</p>
<pre><code>&quot;JBoss Fuse combines core Enterprise Service Bus capabilities (based on Apache Camel, Apache CXF, Apache ActiveMQ), Apache Karaf and Fuse Fabric in a single integrated distribution.&quot;
</code></pre>
<p>但是<a href="http://servicemix.apache.org/" target="_blank" rel="noopener">Apache ServiceMix</a>确实是Fuse中最核心的组成部分，实现了ESB的核心功能。</p>
<pre><code>”Apache ServiceMix is a flexible, open-source integration container that unifies the features and functionality of Apache ActiveMQ, Camel, CXF, ODE, Karaf into a powerful runtime platform you can use to build your own integrations solutions. It provides a complete, enterprise ready ESB exclusively powered by OSGi.“
</code></pre>
<p>ServiceMix是一个开源的ESB，使用Apache CXF发布服务，使用Apache Camel实现路由，使用Apache ActiveMQ实现可靠的消息传输。<br>
ServiceMix使用OSGi将上述这些组件整合到一起，并使用Apache Karaf作为OSGi容器。</p>
<img src="/2014/01/20/about_fuse_esb/servicemix_karaf.png">
<h1 id="apache-cxf"><a class="markdownIt-Anchor" href="#apache-cxf"></a> Apache CXF</h1>
<p><a href="http://cxf.apache.org/" target="_blank" rel="noopener">Apache CXF</a>已经成了Java发布WebService的事实标准。</p>
<p>CXF 继承了 Celtix 和 XFire 两大开源项目的精华，提供了对 JAX-WS 和 JAX-RS 全面的支持，并且提供了多种 Binding 、DataBinding、Transport 以及各种 Format 的支持，并且可以根据实际项目的需要，采用代码优先（Code First）或者 WSDL 优先（WSDL First）来轻松地实现 Web Services 的发布和使用。</p>
<p>关于使用Fuse发布Web Service，可以参考：<a href="/2014/01/23/develop_a_fuse_webservice.html">《JBoss Fuse: 开发和部署Web Service》</a>。</p>
<h1 id="apache-camel"><a class="markdownIt-Anchor" href="#apache-camel"></a> Apache Camel</h1>
<p>Apache Camel基于规则路由和中介引擎实现了<a href="http://camel.apache.org/enterprise-integration-patterns.html" target="_blank" rel="noopener">企业集成模式(EIP,Enterprise Integration Patterns)</a><br>
，可以基于POJO定义路由配置和中介的规则，不需要大量的XML配置文件。</p>
<p>Camel基于OSGi框架并使用依赖注入。支持Blueprint或Spring DM作为OSGi的依赖注入的框架。</p>
<p>这里有关于Camel的介绍：<a href="/2014/02/10/apache_camel.html">《Camel的核心概念》</a>。</p>
<h1 id="apache-aries-blueprint"><a class="markdownIt-Anchor" href="#apache-aries-blueprint"></a> Apache Aries Blueprint</h1>
<p>有一些项目致力于将OSGi引入到企业级应用环境，比如<a href="http://aries.apache.org/" target="_blank" rel="noopener">Apache Aries</a>和<a href="http://www.eclipse.org/gemini/" target="_blank" rel="noopener">Eclipse Gemini</a>，基于OSGi架构，实现企业应用所需的事务管理(JTA)、命名服务(JNDI)、持久化标准(JPA)、<br>
管理模型(JMX)等功能。</p>
<p>其中，为了解决企业级应用开发所习惯的依赖注入，这些项目都实现了OSGi R4.2中规定了Blueprint标准。<br>
也就是说，<a href="/2014/01/22/osgi_blueprint_container.html">Blueprint是OSGi中的依赖注入规范</a>。<br>
Apache Aries项目中对应的产品就是<a href="http://aries.apache.org/modules/blueprint.html" target="_blank" rel="noopener">Aries Blueprint</a>。</p>
<h1 id="spring-dm"><a class="markdownIt-Anchor" href="#spring-dm"></a> Spring DM</h1>
<p><a href="http://docs.spring.io/osgi/docs/current/reference/html/" target="_blank" rel="noopener">Spring DM(Spring Dynamic Modules)</a>，其目标是使得用Spring开发的应用能够在OSGi容器中运行。Spring DM设计的Spring应用与OSGi平台的关系如下图：</p>
<img src="/2014/01/20/about_fuse_esb/spring-osgi-model.png">
<p>将应用模块封装为OSGi bundle时，需要将该应用的Spring装配文件放置到jar包的<code>META-INF/spring/</code>目录下。<br>
该装配文件除了传统的<code>bean</code>配置外，还可以配置<code>osgi:service</code>，以引用或发布OSGi服务。</p>
<p>也可以在<code>MANIFEST.MF</code>中用<code>Spring-Context</code>参数进行指定。比如：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Spring-<span class="string">Context:</span> config<span class="regexp">/applicationContext.xml, config/</span>beans-security.xml</span><br><span class="line">Spring-<span class="string">Context:</span> *;create-asynchronously=<span class="literal">false</span></span><br><span class="line">Spring-<span class="string">Context:</span> config/osgi-*.xml;wait-<span class="keyword">for</span>-<span class="string">dependencies:</span>=<span class="literal">false</span></span><br><span class="line">Spring-<span class="string">Context:</span> *;<span class="string">timeout:</span>=<span class="number">60</span></span><br><span class="line">Spring-<span class="string">Context:</span> *;publish-<span class="string">context:</span>=<span class="literal">false</span></span><br></pre></td></tr></table></figure>
<p>Spring DM提供了<code>spring-osgi-annotation</code>,<code>spring-osgi-core</code>,<code>spring-osgi-io</code>,<code>spring-osgi-extender</code>等bundle，可以部署到OSGi容器中。</p>
<p>其中，<code>spring-osgi-extender</code>会创建OSGi容器中的“Spring Application Context”，并监听OSGi容器的事件。当有新的bundle部署时，<code>spring-osgi-extender</code>会检查该bundle是否包含<code>Spring-Context</code>或者<code>META-INF/spring/</code>中的装配文件。如果有，则将其视为“spring bundle”，会根据装配文件进行bean的组装，当需要引用或发布OSGi服务时，<code>spring-osgi-extender</code>会调用OSGi框架中相应的方法。<br>
最后，将bean加入到Application Context中。</p>
<p>Spring DM与Blueprint的功能非常类似，实际上，先有Spring DM，然后才有Blueprint。尽管Spring DM项目已经停止了，但是<br>
为了适应“遗留系统”，在ServiceMix中依然集成了SpringDM。</p>
<h1 id="apache-activemq"><a class="markdownIt-Anchor" href="#apache-activemq"></a> Apache ActiveMQ</h1>
<p><a href="http://activemq.apache.org/" target="_blank" rel="noopener">Apache ActiveMQ</a>是老牌的开源MQ软件，支持JMS 1.1和2.0，支持集群和容错(Fault Tolerance)，可以实现发布/定义、点对点、分组、流等消息传递模式，提供了高可用(HA)和负载均衡机制。</p>
<p>本来差点被<a href="">RabbitMQ</a>强了位置，但是ActiveMQ迅速支持了AMQP 1.0，估计其地位还会稳固相当一段时间。</p>
<img src="/2014/01/20/about_fuse_esb/activemq.png">
<h1 id="apache-karaf"><a class="markdownIt-Anchor" href="#apache-karaf"></a> Apache Karaf</h1>
<p><a href="http://karaf.apache.org/" target="_blank" rel="noopener">Apache Karaf</a>是一个轻量级的OSGi容器，使用Apache Felix作为OSGi运行时，提供控制台、日志、热部署、依赖注入等功能。</p>
<img src="/2014/01/20/about_fuse_esb/Karaf.jpg">
<p>虽然Equinox与Felix可以单独使用，但Karaf旨在结合这两个框架出色的OSGi功能，并且保证其开箱即用。<br>
比如说，它包含了一个可配置的日志系统（基于Log4J，但针对众多通用的日志系统进行了包装）、通过SSH实现的远程访问、通过ConfigAdmin进行配置以及内建的JAAS支持。不仅如此，Karaf还安装了Pax URL的MVN协议，这样就可以从Maven中央仓库（在必要的情况下会自动将其包装为bundle）安装bundle了。</p>
<p>此外，Karaf还提出了特性的概念，所谓特性就是bundle的集合，能以组的形式安装到运行着的OSGi运行时当中。特性包含了对obr、jetty以及spring的支持，做到了开箱即用。这样，如果需要安装多个bundle，但这些bundle之间并没有严格的运行期依赖，那么这种支持就可以大大简化这种情况。在迁移到Apache Felix项目中前Karaf是ServiceMix Kernel，并且最终成为了Apache的顶级项目。Karaf还加入到了其他框架当中，如Eclipse Virgo和EclipseRT packages，提供了预先配置的框架与好用的OSGi bundle，这样在上手使用OSGi运行时时就会比以往更加简单。</p>
<p>Karaf已经被诸多Apache项目作为基础容器,比如Apache Geronimo, Apache ServiceMix, Fuse ESB等。</p>
<h1 id="felix和equinox"><a class="markdownIt-Anchor" href="#felix和equinox"></a> Felix和Equinox</h1>
<p>OSGi运行时(runtime)的几个实现中，<a href="http://www.knopflerfish.org/" target="_blank" rel="noopener"></a>的推广度程度不高，<a href="http://www.infoq.com/cn/news/2012/11/spring-osgi-gradle" target="_blank" rel="noopener">SpringDM已经被放弃</a>。</p>
<p><a href="http://www.eclipse.org/equinox/" target="_blank" rel="noopener">Equinox</a>跟随Eclipse大放光彩之后，却很难进入企业级应用领域。<br>
而<a href="http://felix.apache.org/" target="_blank" rel="noopener">Felix</a>无论是从自身表现还是推广程度来看，可以说前景非常良好。</p>
<h1 id="fuse-fabric"><a class="markdownIt-Anchor" href="#fuse-fabric"></a> Fuse Fabric</h1>
<p>由于Fuse基于大量的开源项目，要实现配置管理、集群以及部署就变得非常复杂。</p>
<p><a href="http://fuse.fusesource.org/fabric/" target="_blank" rel="noopener">Fuse Fabric</a>是一个开源的集成平台(iPaaS)，能够简化部署和变更管理等工作。</p>
<p>Fabirc基于Apache ZooKeeper建立了一个注册中心，利用git的分布式版本控制管理部署描述符(profiles)，对各个容器进行管理，包括<br>
变更管理、滚动升级以及版本回退。</p>
<img src="/2014/01/20/about_fuse_esb/fabric-diagram.png">
<p>Fuse Fabric支持对Fuse ESB, Fuse MQ, Apache ActiveMQ, Camel, CXF, Karaf, ServiceMix等软件的管理。</p>
<h1 id="apache-zookeeper"><a class="markdownIt-Anchor" href="#apache-zookeeper"></a> Apache ZooKeeper</h1>
<p><a href="http://zookeeper.apache.org/" target="_blank" rel="noopener">Apache Zookeeper</a>，是Apache Hadoop 的一个子项目，它主要是用来解决分布式应用中经常遇到的一些数据管理问题，如：统一命名服务、状态同步服务、集群管理、分布式应用配置项的管理等。通常，ZoopKeeper被用于配置文件的管理、集群管理、同步锁、Leader 选举、队列管理等。</p>
<h1 id="hawtio"><a class="markdownIt-Anchor" href="#hawtio"></a> HawtIO</h1>
<p><a href="http://hawt.io/" target="_blank" rel="noopener">Hawt IO</a> 是一个基于HTML5的Web控制台，可以通过配置和使用<a href="http://hawt.io/plugins/index.html" target="_blank" rel="noopener">大量的插件</a>管理基于Java的应用或平台。Hawt IO自带的插件包括基于git的Dashboard, Wiki, 日志, 健康状态, JMX, OSGi, Apache ActiveMQ, Apache Camel, Apache OpenEJB, Apache Tomcat, Jetty, JBoss, Fuse Fabric等，也可以很容易开发自己的插件。</p>
<p>新版本的ActiveMQ、Fuse等都使用HawtIO作为管理控制台。</p>
<p>HawtIO的目标是：”为每一个JVM提供一个基于Web的控制台“。</p>
<h1 id="标准和规范"><a class="markdownIt-Anchor" href="#标准和规范"></a> 标准和规范</h1>
<h2 id="osgi"><a class="markdownIt-Anchor" href="#osgi"></a> OSGi</h2>
<p>[OSGi(Open Services Gateway initiative)](<a href="http://www.osgi.org/Main/HomePage%E6%98%AF%E4%B8%80%E4%B8%AA%E6%A0%87%E5%87%86%EF%BC%8C" target="_blank" rel="noopener">http://www.osgi.org/Main/HomePage是一个标准，</a><br>
致力于为Java提供一个模块化的底层环境，以及一系列通用的服务(Service）。</p>
<p>和普通的JVM程序相比，OSGi的程序天生拥有动态模块的特点，不同的模块(OSGi里称之为Bundle)有着独立的生命周期，可以独立进行安装、启动、停止、卸载的操作，模块间的依赖性管理也由OSGi提供。</p>
<p>OSGi非常适合需要进行Plugin管理的项目，一个典型的成功案例就是Eclipse和它众多的Plugin。OSGi标准还规范了一系列我们常间的操作，日志、配置文件、事件队列、Web开发、JPA&amp;JDBC等等，大部分部署OSGi标准的框架都提供了这些服务。</p>
<img src="/2014/01/20/about_fuse_esb/osgi.png">
<h2 id="jaxws-jaxb-sax"><a class="markdownIt-Anchor" href="#jaxws-jaxb-sax"></a> JAX‐WS, JAXB, SAX</h2>
<p><a href="https://jcp.org/en/jsr/detail?id=224" target="_blank" rel="noopener">JSR 224: JAX-WS (Java API for XML-Based Web Services)</a>，一组XML web services的JAVA API规范，允许开发者选择RPC-oriented或者message-oriented 来实现自己的web services。</p>
<p>JAX-WS使用<a href="https://jcp.org/en/jsr/detail?id=222" target="_blank" rel="noopener">JSR 222: JAXB(Java Architecture for XML Binding)</a>作为绑定的规范，使用<a href="https://jcp.org/en/jsr/detail?id=173" target="_blank" rel="noopener">JSR 173: SAX(Streaming API for XML)</a>作为XML解析的规范。Java EE 6 引入了对 JAX-WS 的支持。</p>
<img src="/2014/01/20/about_fuse_esb/jax-ws.gif">
<h2 id="jaxrs"><a class="markdownIt-Anchor" href="#jaxrs"></a> JAX‐RS</h2>
<p><a href="https://jcp.org/en/jsr/detail?id=311" target="_blank" rel="noopener">JSR 311: JAX-RS(The Java API for RESTful Web Services)</a>,定义一个统一的规范，使得 Java 程序员可以使用一套固定的接口来开发 REST 应用，避免了依赖于第三方框架。同时，JAX-RS 使用 POJO 编程模型和基于标注的配置，并集成了 JAXB，从而可以有效缩短 REST 应用的开发周期。<br>
Java EE 6 引入了对 JAX‐RS  的支持。</p>
<h2 id="blueprint"><a class="markdownIt-Anchor" href="#blueprint"></a> Blueprint</h2>
<p>Blueprint提供了一个针对OSGi的依赖注入的框架，通过XML文件定义和描述各种元件组的装配。</p>
<p>OSGi R4.2对Blueprint进行了标准化。</p>
<p>目前主要有Apache Aries和Eclipse Gemini两个实现。</p>
<h2 id="eip"><a class="markdownIt-Anchor" href="#eip"></a> EIP</h2>
<p><a href="http://www.enterpriseintegrationpatterns.com/" target="_blank" rel="noopener">EIP(Enterprise Integration Patterns)</a>，企业整合模式。</p>
<h2 id="jbitodo"><a class="markdownIt-Anchor" href="#jbitodo"></a> JBI(TODO)</h2>
<p><a href="https://jcp.org/en/jsr/detail?id=208" target="_blank" rel="noopener">JSR 208: JBI(Java Business Integration)</a>是一种SOA的组件整合标准模型。</p>
<p>SOA在Java领域有两套标准：</p>
<ul>
<li>商业的SCA和SDO标准，由IBM和BEA等公司推出。其中SCA实现了业务组件和传输协议的分离，可以处理各种平台组件的集成；SDO可以的自由读取各种不同数据源的数据。</li>
<li>JSR组织的JBI标准，由SUN最早推出，但是没有得到BEA和IBM的承认。JBI只关注Java组件的集成。</li>
</ul>
<p>JBI容器由三部分组成：</p>
<img src="/2014/01/20/about_fuse_esb/jbi_3_parts.gif">
<ul>
<li>
<p>BC(Binding Components)</p>
<p>绑定组件用于接收各种不同传输协议的请求。可以细分为接收BC和发送BC：接收BC主要负责发送请求和接收响应，发送BC主要用来调用外部的服务。</p>
</li>
<li>
<p>SE(Service Engines)</p>
<p>服务引擎处理JBI容器内部的消息。JBI容器通常在接收到消息后，需要对请求的消息做一些“处理”，然后再调用外部服务的提供者。根据功能的不同，将SE组件分为以下三种类型：</p>
<ul>
<li>Transform SE：处理各种传输协议和格式变化</li>
<li>BPEL SE：将Web Service进行流程编排</li>
<li>Rules SE：按照规则将各种服务进行集成</li>
</ul>
</li>
<li>
<p>NMB(Normalized Message Router)</p>
<p>规格化消息路由器是JBI内部消息系统的核心，所有的组建之间不能交换消息，只能通过NMR来传递。</p>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://holbrook.github.io/2014/01/18/swt_jfreechart_candlestick.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Holbrook">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="心内求法">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014/01/18/swt_jfreechart_candlestick.html" itemprop="url">在SWT中用JFreeChart实现K线图</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-01-18T00:00:00+08:00">
                2014-01-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/软件技术/" itemprop="url" rel="index">
                    <span itemprop="name">软件技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2014/01/18/swt_jfreechart_candlestick.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2014/01/18/swt_jfreechart_candlestick.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="目标"><a class="markdownIt-Anchor" href="#目标"></a> 目标</h1>
<p>在<a href="/2013/05/03/r_notes_1_what.html">R学习笔记</a>中，展示了这样一张图表：</p>
<img src="/2014/01/18/swt_jfreechart_candlestick/2.png">
<p>现在需要在Eclipse e4应用中实现这样的图表。</p>
<h1 id="swt图表组件的选择"><a class="markdownIt-Anchor" href="#swt图表组件的选择"></a> SWT图表组件的选择</h1>
<p>在RCP/JFace/SWT中，可以选择的图表组件包括：</p>
<ul>
<li>
<p>Eclipse BIRT</p>
<p><a href="http://www.eclipse.org/birt/phoenix/" target="_blank" rel="noopener">Eclipse BIRT</a>是Eclipse平台下的报表框架。其中的图表组件可以单独使用。<br>
由于BIRT依赖于GEF、EMF等Eclipse插件，所以非常重，不适合简单轻量的应用。</p>
</li>
<li>
<p>SWT Chart</p>
<p>从名字就可以看出，<a href="http://www.swtchart.org/" target="_blank" rel="noopener">SWT Chart</a>是专为SWT环境开发的报表组件。设计很清晰，使用起来也方便。但是目前支持的图表类型比较少。</p>
</li>
<li>
<p>JFreeChart</p>
<p><a href="http://www.jfree.org/jfreechart/" target="_blank" rel="noopener">JFreeChart</a>是Java世界的老牌图表组件，其强大无以言表。JFreeChart支持AWT、Swing等<br>
GUI环境，也可以生成图片在Web环境中使用。后来又增加了对SWT环境的支持，从此不再需要SWT_AWT的桥接方式。</p>
</li>
</ul>
<p>综上所述，这里选择JFreeChart作为绘图组件。</p>
<h1 id="获取股票数据"><a class="markdownIt-Anchor" href="#获取股票数据"></a> 获取股票数据</h1>
<p>由于需要的数据量比较大，不能再使用<a href="">前面</a>的模拟数据方法了。这里使用<a href="http://finance.yahoo.com/" target="_blank" rel="noopener">雅虎财经</a>的数据。</p>
<p>雅虎财经提供了查询股票历史数据的接口：</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="string">//table.finance.yahoo.com/table.csv</span>?ignore=<span class="string">.csv</span>&amp;<span class="string">....</span></span><br></pre></td></tr></table></figure>
<p>参数包括：</p>
<ul>
<li>s: 股票代码/名称。对于国内的股票，使用类似<code>000001.ss</code>的编码</li>
<li>a、b、c: 开始时间的月、日、年</li>
<li>d、e、f: 结束时间的月、日、年</li>
<li>g：时间周期，分别为<code>d</code>:日， <code>w</code>:周，<code>m</code>：月， <code>v</code>:dividends only</li>
</ul>
<p>其中，月份是从0开始。比如，9月数据写为08。</p>
<p>本文中使用2013年上证综合指数的日线数据：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">http:</span><span class="comment">//table.finance.yahoo.com/table.csv?ignore=.csv&amp;s=000001.ss&amp;a=00&amp;b=01&amp;c=2013&amp;d=11&amp;e=31&amp;f=2013&amp;g=d</span></span><br></pre></td></tr></table></figure>
<p>获取到的CSV文件包含的数据列为<code>Date,Open,High,Low,Close,Volume,Adj Close</code>，其中Date的格式为<code>yyyy-MM-dd</code>。数据按照日期倒序排列。</p>
<p>处理代码如下：</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">OHLCSeries ohlcSeries = <span class="keyword">new</span> <span class="type">OHLCSeries</span>(<span class="string">""</span>);</span><br><span class="line">TimeSeries volumeSeries =<span class="keyword">new</span> <span class="type">TimeSeries</span>(<span class="string">""</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">	URL url = <span class="keyword">new</span> <span class="type">URL</span>(<span class="string">"http://table.finance.yahoo.com/table.csv?ignore=.csv&amp;s=000001.ss&amp;a=00&amp;b=01&amp;c=2013&amp;d=11&amp;e=31&amp;f=2013&amp;g=d"</span>);</span><br><span class="line">	InputStream is = url.openStream();</span><br><span class="line">	InputStreamReader reader = <span class="keyword">new</span> <span class="type">InputStreamReader</span>(is,<span class="string">"UTF-8"</span>);</span><br><span class="line"></span><br><span class="line">	BufferedReader buffer = <span class="keyword">new</span> <span class="type">BufferedReader</span>(reader);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">String</span> <span class="keyword">new</span><span class="type">Line</span> = buffer.readLine();<span class="comment">// 标题行</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> ((<span class="keyword">new</span><span class="type">Line</span> = buffer.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">           <span class="keyword">String</span> item[] = <span class="keyword">new</span><span class="type">Line</span>.trim().split(<span class="string">","</span>);</span><br><span class="line">           Date date = df.parse(item[<span class="number">0</span>]);</span><br><span class="line">           float open = <span class="keyword">Float</span>.valueOf(item[<span class="number">1</span>]);</span><br><span class="line">           float high = <span class="keyword">Float</span>.valueOf(item[<span class="number">2</span>]);</span><br><span class="line">           float low = <span class="keyword">Float</span>.valueOf(item[<span class="number">3</span>]);</span><br><span class="line">           float close = <span class="keyword">Float</span>.valueOf(item[<span class="number">4</span>]);</span><br><span class="line">           float volume = <span class="keyword">Float</span>.valueOf(item[<span class="number">5</span>]);</span><br><span class="line">           float adj_close = <span class="keyword">Float</span>.valueOf(item[<span class="number">6</span>]);</span><br><span class="line"></span><br><span class="line">           ohlcSeries.add(<span class="keyword">new</span> <span class="type">Day</span>(date), open,high,low,close);</span><br><span class="line">           volumeSeries.add(<span class="keyword">new</span> <span class="type">Day</span>(date),volume);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">	e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="联合图表"><a class="markdownIt-Anchor" href="#联合图表"></a> 联合图表</h1>
<p>目标中的图表是一种联合图表(Combined Chart)：多个图表共用横坐标或纵坐标。JFreeChart中提供了<code>CombinedDomainXYPlot</code>和<code>CombinedRangeXYPlot</code>，分别用于联合横坐标和联合纵坐标的图表。</p>
<p>由于各种图表类型都有可能组成联合图表，JFreeChart没有在<code>ChartFactory</code>中提供工厂方法进行创建，<br>
只能按照<a href="/2014/01/17/jfreechart.html#menuIndex1">JFreeChart中的图表模型</a>进行手工创建。下面是例子：</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建横坐标轴，作为联合坐标</span></span><br><span class="line">DateAxis timeAxis = <span class="keyword">new</span> <span class="type">DateAxis</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建两个纵坐标，用于上下两个Plot</span></span><br><span class="line">NumberAxis ohlcAxis = <span class="keyword">new</span> <span class="type">NumberAxis</span>();</span><br><span class="line">NumberAxis volumeAxis = <span class="keyword">new</span> <span class="type">NumberAxis</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建两个Plot对应的Renderer</span></span><br><span class="line">CandlestickRenderer ohlcRenderer = <span class="keyword">new</span> <span class="type">CandlestickRenderer</span>();</span><br><span class="line">XYBarRenderer volumeRenderer = <span class="keyword">new</span> <span class="type">XYBarRenderer</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建K线图的Plot，使用“数据”一节中的ohlcSeries</span></span><br><span class="line"><span class="comment">////其中横坐标设为"null"，以使用联合横坐标</span></span><br><span class="line">OHLCSeriesCollection ohlcDataset = <span class="keyword">new</span> <span class="type">OHLCSeriesCollection</span>();</span><br><span class="line">ohlcDataset.addSeries(ohlcSeries);</span><br><span class="line">XYPlot ohlcPlot = <span class="keyword">new</span> <span class="type">XYPlot</span>(ohlcDataset,timeAxis,ohlcAxis,ohlcRenderer);</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建成交量柱状图的Plot，使用“数据”一节中的volumeSeries</span></span><br><span class="line"><span class="comment">//其中横坐标设为"null"，以使用联合横坐标</span></span><br><span class="line">TimeSeriesCollection volumeDataset = <span class="keyword">new</span> <span class="type">TimeSeriesCollection</span>();</span><br><span class="line">volumeDataset.addSeries(timeSeries);</span><br><span class="line">XYPlot volumePlot=<span class="keyword">new</span> <span class="type">XYPlot</span>(volumeDataset,<span class="literal">null</span>,volumeAxis,volumeRenderer;</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建联合图表</span></span><br><span class="line">CombinedDomainXYPlot combineddomainxyplot = <span class="keyword">new</span> <span class="type">CombinedDomainXYPlot</span>(timeAxis());</span><br><span class="line"></span><br><span class="line"><span class="comment">//上下两个图表占据的高度比例为2:1，间隔为10</span></span><br><span class="line">combineddomainxyplot.add(ohlcPlot, <span class="number">2</span>);</span><br><span class="line">combineddomainxyplot.add(volumePlot, <span class="number">1</span>);</span><br><span class="line">combineddomainxyplot.setGap(<span class="number">10</span>);</span><br><span class="line">JFreeChart chart = <span class="keyword">new</span> <span class="type">JFreeChart</span>(<span class="string">"xx股票"</span>, JFreeChart.DEFAULT_TITLE_FONT, combineddomainxyplot, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure>
<p>创建的图表如下所示：</p>
<img src="/2014/01/18/swt_jfreechart_candlestick/sample1.png">
<h1 id="设置样式"><a class="markdownIt-Anchor" href="#设置样式"></a> 设置样式</h1>
<p>上面的图表默认样式与国内的习惯不大一样。不过JFreeChart提供了丰富的API进行样式的设置。下面对样式进行简单调整(目前对SWT的支持不够完全。比如，颜色值仍需要使用AWT的<code>Color</code>类)：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//图表</span></span><br><span class="line"><span class="selector-tag">chart</span><span class="selector-class">.setBackgroundPaint</span>(Color.BLACK);</span><br><span class="line"><span class="selector-tag">chart</span><span class="selector-class">.getTitle</span>()<span class="selector-class">.setPaint</span>(Color.WHITE);</span><br><span class="line"><span class="selector-tag">chart</span><span class="selector-class">.setBorderVisible</span>(false);</span><br><span class="line"></span><br><span class="line"><span class="comment">//Plot</span></span><br><span class="line"><span class="selector-tag">combineddomainxyplot</span><span class="selector-class">.setBackgroundPaint</span>(Color.BLACK);</span><br><span class="line"><span class="selector-tag">ohlcPlot</span><span class="selector-class">.setBackgroundPaint</span>(Color.BLACK);</span><br><span class="line"><span class="selector-tag">volumePlot</span><span class="selector-class">.setBackgroundPaint</span>(Color.BLACK);</span><br><span class="line"></span><br><span class="line"><span class="comment">//渲染</span></span><br><span class="line"><span class="selector-tag">ohlcRenderer</span><span class="selector-class">.setUpPaint</span>(Color.RED);</span><br><span class="line"><span class="selector-tag">ohlcRenderer</span><span class="selector-class">.setDownPaint</span>(Color.GREEN);</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">volumeRenderer</span><span class="selector-class">.setShadowVisible</span>(false);</span><br><span class="line"></span><br><span class="line"><span class="comment">//坐标轴</span></span><br><span class="line"><span class="selector-tag">timeAxis</span><span class="selector-class">.setTickLabelPaint</span>(Color.GRAY);</span><br><span class="line"><span class="selector-tag">ohlcAxis</span><span class="selector-class">.setTickLabelPaint</span>(Color.GRAY);</span><br><span class="line"><span class="selector-tag">volumeAxis</span><span class="selector-class">.setTickLabelPaint</span>(Color.GRAY);</span><br></pre></td></tr></table></figure>
<p>调整后的图表如下所示：</p>
<img src="/2014/01/18/swt_jfreechart_candlestick/sample2.png">
<h1 id="去除非交易时段"><a class="markdownIt-Anchor" href="#去除非交易时段"></a> 去除非交易时段</h1>
<p>前面的例子中，K线是不连续的，因为会有非交易日的存在。如果是小时、分钟级别的K线图，该问题会更加明显。</p>
<p>要去除非交易时段，使得K线连续，大体有两个思路：</p>
<ul>
<li>实现一个自定义的<code>DateAxis</code>，根据数据的序号产生坐标，根据实际时间产生标签</li>
<li>实现一个<code>Timeline</code>，并设置给<code>DateAxis</code></li>
<li>更改Renderer</li>
</ul>
<p>看起来方法1更容易，但由于没有相关的文档，需要自己分析<code>DateAxis</code>的代码，类似一种“Hack”的模式，很难保证向后兼容；<br>
方法2是官方指定的方法，可行性更高，但是要同时支持日线、小时线、分钟/5分钟线，实现起来有点难度。<br>
此外，<a href="http://www.jfree.org/jfreechart/api/javadoc/org/jfree/chart/axis/Timeline.html" target="_blank" rel="noopener">Timeline的接口说明</a>读起来有些费解；方法3需要改变数据源(Dataset)，使用序号作为数据，设置Renderer的<code>ItemLabelGenerator</code>，根据序号产生时间格式的坐标标签。</p>
<p>这里采用方法3，实例代码如下：</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//TODO</span></span><br></pre></td></tr></table></figure>
<h1 id="修正高度和宽度todo"><a class="markdownIt-Anchor" href="#修正高度和宽度todo"></a> 修正高度和宽度(TODO)</h1>
<ul>
<li>
<p>固定每根K线的宽度，根据图表宽度决定显示多少根K线</p>
</li>
<li>
<p>使用“时间窗口”作为数据</p>
</li>
</ul>
<h1 id="横向滚动和实时曲线todo"><a class="markdownIt-Anchor" href="#横向滚动和实时曲线todo"></a> 横向滚动和实时曲线(TODO)</h1>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://holbrook.github.io/2014/01/17/jfreechart.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Holbrook">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="心内求法">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014/01/17/jfreechart.html" itemprop="url">JFreeChart概述</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-01-17T00:00:00+08:00">
                2014-01-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/软件技术/" itemprop="url" rel="index">
                    <span itemprop="name">软件技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2014/01/17/jfreechart.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2014/01/17/jfreechart.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>JFreeChart的图表模型及使用示例。</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2014/01/17/jfreechart.html#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://holbrook.github.io/2014/01/12/e4_platform_services.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Holbrook">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="心内求法">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014/01/12/e4_platform_services.html" itemprop="url">Eclipse e4中的平台服务</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-01-12T00:00:00+08:00">
                2014-01-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/软件技术/" itemprop="url" rel="index">
                    <span itemprop="name">软件技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2014/01/12/e4_platform_services.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2014/01/12/e4_platform_services.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="概述"><a class="markdownIt-Anchor" href="#概述"></a> 概述</h1>
<p><a href="/2014/01/12/dependency_injection_in_e4.html">前面</a>提到，e4中可以通过依赖注入进行服务的发布和获取。并且，”在Eclipse e4中，将全局的上下文分成了多个层次“：</p>
<img src="/2014/01/12/e4_platform_services/e4_context_hierarchy.png" title="e4上下文的层级">
<p>e4提供了很多平台级的服务，注册于OSGi context之上的其他各个context层。这些服务提供了开发应用的很多通用的功能。一些常用的服务包括：</p>
<p>展现层MVC的视图、模型、控制器相关的服务，以及逻辑层服务。</p>
<ul>
<li>
<p>视图相关服务</p>
<ul>
<li>
<p>EPartService</p>
<p>访问和修改Part，使用Part模板，切换perspectives，支持Edit方法</p>
</li>
<li>
<p>ESelectionService</p>
<p>处理GUI界面中的”选中“</p>
</li>
<li>
<p>EMenuService</p>
<p>Registers a popup menu (MPopupMenu) for an SWT control.</p>
</li>
<li>
<p>org.eclipse.jface.window.IShellProvider</p>
<p>在SWT环境中访问Shell</p>
</li>
<li>
<p>IThemeEngine</p>
<p>Allows to switch the styling of the application at runtime.</p>
</li>
</ul>
</li>
<li>
<p>模型相关服务</p>
<ul>
<li>
<p>EModelService</p>
<p>在运行时访问或更改e4的<a href="/2014/01/07/eclipse_e4_RCP_quickstart.html#menuIndex1">应用模型</a></p>
</li>
</ul>
</li>
<li>
<p>控制器相关服务</p>
<ul>
<li>
<p>MDirtyable</p>
<p>用于标记Part中的内容是否被修改过</p>
</li>
<li>
<p>ECommandService</p>
<p>访问、创建和更改应用模型中的command对象</p>
</li>
<li>
<p>EHandlerService</p>
<p>访问、更改或触发(trigger)应用模型中的handler对象</p>
</li>
</ul>
</li>
<li>
<p>逻辑层相关服务</p>
<ul>
<li>
<p>IEventBroker</p>
<p>提供基于发布、订阅机制的事件处理功能</p>
</li>
<li>
<p>StatusReporter</p>
<p>Allows you to report Status objects.</p>
</li>
<li>
<p>EContextService</p>
<p>Activate and deactivate key bindings defined as BindingContext in the application model. The content referred to in this service is the BindingContext and not the IEclipseContext.</p>
</li>
<li>
<p>Logger</p>
<p><code>org.eclipse.e4.core.services</code>插件中的<code>Logger</code>提供了日志功能</p>
</li>
<li>
<p>Adapter</p>
<p>An adapter can adapt an object to the specified type, allowing clients to request domain-specific behavior for an object. It integrates IAdaptable and IAdapterManager</p>
</li>
</ul>
</li>
</ul>
<h1 id="视图相关服务"><a class="markdownIt-Anchor" href="#视图相关服务"></a> 视图相关服务</h1>
<h2 id="epartservice"><a class="markdownIt-Anchor" href="#epartservice"></a> EPartService</h2>
<p>在应用模型中，可以定义PartDescriptors。PartDescriptors可以作为创建Part的模板。</p>
<img src="/2014/01/12/e4_platform_services/PartDescriptors.png">
<p>通过EPartService可以访问这些模板，比如：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Inject</span> <span class="keyword">private</span> EPartService partService;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Showing and hiding parts</span></span><br><span class="line">detailsTodoPart = partService.findPart(<span class="string">"com.example.todo.rcp.parts.tododetails"</span>);</span><br><span class="line">partService.hidePart(detailsTodoPart);</span><br><span class="line">……</span><br><span class="line">detailsTodoPart.setVisible(<span class="keyword">true</span>);</span><br><span class="line">partService.showPart(detailsTodoPart, PartState.VISIBLE);</span><br><span class="line"></span><br><span class="line"><span class="comment">//Switching perspectives</span></span><br><span class="line"><span class="meta">@Execute</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> execute(MApplication app, EPartService partService,</span><br><span class="line">      EModelService modelService) &#123;</span><br><span class="line">    MPerspective element =</span><br><span class="line">        (MPerspective) modelService.find(<span class="string">"secondperspective"</span>, app);</span><br><span class="line">    <span class="comment">// now switch perspective</span></span><br><span class="line">    partService.switchPerspective(element);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// creating parts dynamically</span></span><br><span class="line"><span class="meta">@Execute</span></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">execute</span><span class="params">(EPartService partService)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// create a new Part based on a PartDescriptor</span></span><br><span class="line">    <span class="comment">// in the application model</span></span><br><span class="line">    <span class="comment">// assume the ID is used for the PartDescriptor</span></span><br><span class="line">    MPart part = partService</span><br><span class="line">        .createPart(<span class="string">"com.example.e4.rcp.todo.partdescriptor.fileeditor"</span>);</span><br><span class="line">    part.setLabel(<span class="string">"New Dynamic Part"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If multiple parts of this type are now allowed</span></span><br><span class="line">    <span class="comment">// in the application model,</span></span><br><span class="line">    <span class="comment">// then the provided part will be shown</span></span><br><span class="line">    <span class="comment">// and returned</span></span><br><span class="line">    partService.showPart(part, PartState.ACTIVATE);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//switch perspective</span></span><br><span class="line"><span class="meta">@Execute</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> execute(MApplication app, EPartService partService,</span><br><span class="line">      EModelService modelService) &#123;</span><br><span class="line">    MPerspective element =</span><br><span class="line">        (MPerspective) modelService.find(<span class="string">"secondperspective"</span>, app);</span><br><span class="line">    partService.switchPerspective(element);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h2 id="eselectionservice"><a class="markdownIt-Anchor" href="#eselectionservice"></a> ESelectionService</h2>
<p>e4的应用模型中，MWindow对象可以保持选中的Part。e4在IEclipseContext中注册了<code>ESelectionService</code>，可以设置或获取选中的组件。</p>
<p>使用<code>setSelection()</code>方法可以设置选中状态：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// use field injection for the service</span></span><br><span class="line"><span class="meta">@Inject</span> ESelectionService selectionService;</span><br><span class="line"></span><br><span class="line"><span class="comment">// viewer is a JFace Viewer</span></span><br><span class="line">viewer.addSelectionChangedListener(<span class="keyword">new</span> ISelectionChangedListener() &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">selectionChanged</span><span class="params">(SelectionChangedEvent event)</span> </span>&#123;</span><br><span class="line">    IStructuredSelection selection = (IStructuredSelection)</span><br><span class="line">        viewer.getSelection();</span><br><span class="line">    selectionService.setSelection(selection.getFirstElement());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>使用<code>getSelection(partId)</code>方法可以获取选中的组件，更常用的做法是使用<code>IServiceConstants.ACTIVE_SELECTION</code>作为<code>@Named</code>注解的参数，自动注入选中的组件：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@Inject</span></span><br><span class="line">public void setTodo(<span class="variable">@Optional</span></span><br><span class="line">    <span class="variable">@Named</span>(IServiceConstants.ACTIVE_SELECTION) Todo todo) &#123;</span><br><span class="line">  <span class="selector-tag">if</span> (todo != null) &#123;</span><br><span class="line">    <span class="comment">// do something with the value</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="模型相关服务emodelservice"><a class="markdownIt-Anchor" href="#模型相关服务emodelservice"></a> 模型相关服务EModelService</h1>
<p>使用<code>EModelService</code>可以在运行时访问或更改e4的<a href="/2014/01/07/eclipse_e4_RCP_quickstart.html#menuIndex1">应用模型</a>，比如增加或删除模型元素。EModelService中一些常用的方法包括：</p>
<ul>
<li><code>cloneElement()</code>和<code>cloneSnippet()</code>：克隆元素或模型片段</li>
<li><code>findElements()</code>：通过ID、类型、或标签(tags)搜索元素</li>
</ul>
<p>使用举例：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//search by type</span></span><br><span class="line">  private <span class="keyword">void</span> findParts(MApplication application,</span><br><span class="line">      EModelService service) &#123;</span><br><span class="line">    <span class="built_in">List</span>&lt;MPart&gt; parts = service.findElements(application, <span class="keyword">null</span>,</span><br><span class="line">        MPart.<span class="keyword">class</span>, <span class="keyword">null</span>);</span><br><span class="line">    System.out.println(<span class="string">"Found parts(s) : "</span> + parts.size());</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Dynamically create a new window</span></span><br><span class="line">MWindow <span class="built_in">window</span> = modelService.createModelElement(MWindow.<span class="keyword">class</span>);</span><br><span class="line"><span class="built_in">window</span>.setWidth(<span class="number">200</span>);</span><br><span class="line"><span class="built_in">window</span>.setHeight(<span class="number">300</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// add new Window to the application</span></span><br><span class="line">application.getChildren().add(<span class="built_in">window</span>);</span><br></pre></td></tr></table></figure>
<h1 id="控制器相关服务"><a class="markdownIt-Anchor" href="#控制器相关服务"></a> 控制器相关服务</h1>
<h2 id="mdirtyable和persist注解"><a class="markdownIt-Anchor" href="#mdirtyable和persist注解"></a> MDirtyable和@Persist注解</h2>
<p>e4中不再区分ViewPart和EditPart，而是统一使用Part。通过MDirtyable可以标记Part中的内容是否被修改过；使用<code>@Persist</code>注解可以标记持久化Part内容的方法。比如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyEditPart</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Inject</span></span><br><span class="line">  MDirtyable dirty;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@PostConstruct</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createControls</span><span class="params">(Composite parent)</span> </span>&#123;</span><br><span class="line">    Button button = <span class="keyword">new</span> Button(parent, SWT.PUSH);</span><br><span class="line">    button.addSelectionListener(<span class="keyword">new</span> SelectionAdapter() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">widgetSelected</span><span class="params">(SelectionEvent e)</span> </span>&#123;</span><br><span class="line">        dirty.setDirty(<span class="keyword">true</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Persist</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">(MDirtyable dirty, ITodoService todoService)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// save changes via ITodoService for example</span></span><br><span class="line">    todoService.saveTodo(todo);</span><br><span class="line">    <span class="comment">// save was successful</span></span><br><span class="line">    dirty.setDirty(<span class="keyword">false</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在上面的例子中，看起来<code>@Persist</code>注解没有多大用处。其实，该注解主要用于EPartService的<code>saveAll()</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SaveHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Execute</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">execute</span><span class="params">(EPartService partService)</span> </span>&#123;</span><br><span class="line">    partService.saveAll(<span class="keyword">false</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ecommandservice和ehandlerservice"><a class="markdownIt-Anchor" href="#ecommandservice和ehandlerservice"></a> ECommandService和EHandlerService</h2>
<p>举例如下：</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Command command = commandService.getCommand(<span class="string">"com.example.mycommand"</span>);</span><br><span class="line"></span><br><span class="line">//<span class="built_in"> check </span>if the command is defined</span><br><span class="line">System.out.println(command.isDefined());</span><br><span class="line"></span><br><span class="line">// activate Handler, assume AboutHandler() class exists already</span><br><span class="line">handlerService.activateHandler(<span class="string">"com.example.mycommand"</span>,</span><br><span class="line">   <span class="built_in"> new </span>AboutHandler());</span><br><span class="line"></span><br><span class="line">ParameterizedCommand cmd =</span><br><span class="line">  commandService.createCommand(<span class="string">"com.example.mycommand"</span>, null);</span><br><span class="line"></span><br><span class="line">//<span class="built_in"> check </span>if the command can get executed</span><br><span class="line">System.out.println(handlerService.canExecute(cmd));</span><br><span class="line"></span><br><span class="line">//<span class="built_in"> execute </span>the command</span><br><span class="line">handlerService.executeHandler(cmd);</span><br></pre></td></tr></table></figure>
<h1 id="逻辑层相关服务"><a class="markdownIt-Anchor" href="#逻辑层相关服务"></a> 逻辑层相关服务</h1>
<h2 id="ieventbroker"><a class="markdownIt-Anchor" href="#ieventbroker"></a> IEventBroker</h2>
<p>Eclipse 3.x中，事件处理使用Observer模式：事件接收者实现事件发布者指定的Listener接口，并注册到事件发布者。<br>
这带来两个问题：</p>
<ul>
<li>一个Listener接口要写很多个实现，这些实现中的代码有重复</li>
<li>事件发布者和接收者的生命周期紧耦合</li>
</ul>
<p>Eclipse e4中，将OSGi的<code>EventAdmin</code>API封装为事件服务，提供了基于发布、订阅机制的事件处理功能：<code>EventBroker</code>作为事件总线，通过<code>EventBroker</code>可以发布和订阅事件。</p>
<p>要使用e4事件服务，需要增加依赖插件：<br>
* org.eclipse.e4.core.services<br>
* org.eclipse.osgi.services</p>
<ul>
<li>获取EventBroker</li>
</ul>
<p>e4中定义了<code>org.eclipse.e4.core.services.events.IEventBroker</code>接口，可以通过依赖注入、e4上下文等方式获取：</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">  @Inject</span><br><span class="line">  IEventBroker eventBroker;</span><br><span class="line"></span><br><span class="line">  @Inject</span><br><span class="line">  private IEclipseContext eclipseContext;</span><br><span class="line">  ……</span><br><span class="line">  IEventBroker eventBroker = eclipseContext.get(IEventBroker.<span class="keyword">class</span>);</span><br><span class="line"></span><br><span class="line">- 发布事件</span><br><span class="line"></span><br><span class="line">可以用`IEventBroker`的`post()`或`send()`方法，进行同步(synchronous)或异步(asynchronous)事件的发布：</span><br></pre></td></tr></table></figure>
<p>boolean IEventBroker.post(String topic, Object data) // synchronous delivery</p>
<p>boolean IEventBroker.send(String topic, Object data) // asynchronous delivery</p>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">返回值为是否发生成功。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- 订阅事件</span><br><span class="line"></span><br><span class="line">可以通过依赖注入或者`IEventBroker`的`subscribe()`方法订阅事件：</span><br></pre></td></tr></table></figure>
<p>@Inject<br>
@Optional<br>
private void closeHandler(@UIEventTopic(’‘TOPIC_STRING’’) foo.Bar payload) {<br>
//do something with payload<br>
}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>@Inject<br>
IEventBroker eventBroker;</p>
<p>org.osgi.service.event.EventHandler closeHandler = new EventHandler() {<br>
public void handleEvent(Event event) {<br>
foo.Bar payload = (foo.Bar) event.getProperty(IEventBroker.DATA);<br>
}<br>
}</p>
<p>eventBroker.subscribe(TOPIC_STRING, closeHandler);<br>
……<br>
eventBroker.unsubscribe(closeHandler);</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">消息对象(payload)作为附件存储在`IEventBroker.DATA`属性中。对于`Dictionary`或`Map`等集合类型的消息，会将其中所有的值按照KEY添加为属性。</span><br><span class="line"></span><br><span class="line">## Logger</span><br><span class="line"></span><br><span class="line">Eclipse <span class="number">3.</span>x中，Log的接口和实现类分别为`org.eclipse.core.runtime.ILog`和`org.osgi.service.log.LogService`，可以使用`ServiceTracker`获取：</span><br></pre></td></tr></table></figure>
<p>LogService getLog() {<br>
fLogServiceTracker = new ServiceTracker(fBundleContext, LogService.class.getName(), null);<br>
return (LogService) fLogServiceTracker.getService();<br>
}</p>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">为了方便，在`Plugin`的基类中实现了`getLog()`方法，所有的`Plugin`子类可以直接使用。</span><br><span class="line"></span><br><span class="line">在`org.eclipse.e4.core.services`插件中提供了`org.eclipse.e4.core.services.Logger`类，可以通过`@Inject`注解或使用`IEclipseContext`接口获取：</span><br></pre></td></tr></table></figure>
<p>@Inject<br>
private Logger logger;</p>
<p>//or use code:<br>
Logger log = (Logger) context.get(Logger.class.getName());</p>
<pre class="highlight"><code class="">


# 实现自己的服务

Usually services have two parts: the interface definition and the implementation. How these two are linked is defined by a context function , an OSGi service or plain context value setting (IEclipseContext). Please note that there can be more than one service implementation for an interface.

</code></pre>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://holbrook.github.io/2014/01/12/emf.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Holbrook">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="心内求法">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014/01/12/emf.html" itemprop="url">仰望MDA，拥抱EMF</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-01-12T00:00:00+08:00">
                2014-01-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/软件技术/" itemprop="url" rel="index">
                    <span itemprop="name">软件技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2014/01/12/emf.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2014/01/12/emf.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>EMF与MOF的理想是类似的，只不过MOF在“仰望星空”，EMF更加“脚踏实地”。&quot;</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2014/01/12/emf.html#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://holbrook.github.io/2014/01/12/dependency_injection_in_e4.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Holbrook">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="心内求法">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014/01/12/dependency_injection_in_e4.html" itemprop="url">Eclipse e4：从OSGi-DS到依赖注入</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-01-12T00:00:00+08:00">
                2014-01-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/软件技术/" itemprop="url" rel="index">
                    <span itemprop="name">软件技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2014/01/12/dependency_injection_in_e4.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2014/01/12/dependency_injection_in_e4.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>e4开始，可以不使用代码或xml进行服务注册和寻找，而使用依赖注入进行装配</p>
<h1 id="manifestmf"><a class="markdownIt-Anchor" href="#manifestmf"></a> MANIFEST.MF</h1>
<p>为了管理一组Java类和资源，通常我们会将其打包为JAR(Java Archive File，java存档文件)，该文件以ZIP格式进行打包。<br>
在JAR文件中，会包含一个<code>META-INF/MANIFEST.MF</code>文件，作为该JAR包的清单文件，设置执行入口类和支持库的路径等信息。<br>
主要内容包括：</p>
<ul>
<li>Manifest-Version</li>
<li>Class-Path</li>
<li>Created-By</li>
<li>Main-Class</li>
</ul>
<h1 id="osgi-bundle"><a class="markdownIt-Anchor" href="#osgi-bundle"></a> OSGi bundle</h1>
<p>OSGi的目标是实现Java应用的模块化，其目标是：</p>
<ul>
<li>将程序封装成一个个的模块(在OSGi中叫做bundle)</li>
<li>模块向外只暴露特定的接口，内部实现对外不可见</li>
<li>OSGi容器管理模块的接口，包括服务发布、寻找和版本管理等</li>
<li>OSGi容器管理模块的生命周期，比如启动、停止、热插拔等</li>
</ul>
<p>OSGi将每个模块打包为一个JAR文件。为了实现上述目标，<br>
OSGi规范利用了<code>MANIFEST.MF</code>文件，在其中增加了一些bundle的描述信息，比如：</p>
<ul>
<li>Bundle-ManifestVersion</li>
<li>Bundle-Name</li>
<li>Bundle-SymbolicName</li>
<li>Bundle-Version</li>
<li>Bundle-ClassPath</li>
<li>Bundle-Vendor</li>
<li>Bundle-Localization</li>
<li>Bundle-RequiredExecutionEnvironment</li>
<li>Export-Package</li>
<li>Require-Bundle</li>
<li>Bundle-Activator</li>
<li>Bundle-ActivationPolicy</li>
<li>Import-Package</li>
</ul>
<h1 id="osgi服务的注册和寻找"><a class="markdownIt-Anchor" href="#osgi服务的注册和寻找"></a> OSGi服务的注册和寻找</h1>
<p>OSGi模块中，只有<code>Export-Package</code>中声明的包才可以被其他模块访问。为了避免一个模块对其他模块的直接引用，<br>
通常会实现一个“接口定义”模块和多个“接口实现”模块。通过服务注册和发现的方式进行服务的使用。</p>
<p>OSGi还可以为模块指定一个&quot;激活类(<code>Bundle-Activator</code>)“，<br>
这个类会在模块启动时被执行，通常在这里进行本模块的接口实现(服务)的发布，以及向本模块内的类注入其他模块实现的接口(服务).<br>
比如：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyActivator</span> <span class="keyword">implements</span> <span class="title">org</span>.<span class="title">osgi</span>.<span class="title">framework</span>.<span class="title">BundleActivator</span>&#123;</span></span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> start(BundleContext context) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		context.registerService(MyService.<span class="keyword">class</span>.getName(), <span class="keyword">new</span> MyServiceImpl(), <span class="literal">null</span>);</span><br><span class="line">		System.out.println(MyService.<span class="keyword">class</span>.getName() + <span class="string">" has been registred as a service"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	……</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样，其他使用该服务的模块可以寻找服务。通常，也是在&quot;激活类(<code>Bundle-Activator</code>)“中进行：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientActivator</span> <span class="keyword">implements</span> <span class="title">BundleActivator</span>&#123;</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> MyService helloService;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> start(BundleContext context) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		ServiceReference ref = context.getServiceReference(MyService.<span class="keyword">class</span>.getName());</span><br><span class="line">		MyService service = (MyService) context.getService(ref);</span><br><span class="line">		MyClient.setService(service);</span><br><span class="line">	&#125;</span><br><span class="line">	……</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="declarative-service"><a class="markdownIt-Anchor" href="#declarative-service"></a> Declarative Service</h1>
<p>上面通过代码的方式进行服务的注册和寻找，实现起来比较繁琐。为了简化编码，从OSGi4.0版本开始，提出了”Declarative Service“标准，<br>
使用xml文件进行服务发布和引用的描述。</p>
<p>首先，在<code>MANIFEST.MF</code>文件中增加一个新的属性<code>Service-Component</code>，用来指定服务声明文件的路径，比如：</p>
<figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Service-<span class="keyword">Component</span>: OSGI-INF/<span class="keyword">component</span>.xml</span><br></pre></td></tr></table></figure>
<p>然后编写服务声明配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="tag">&lt;<span class="name">scr:component</span> <span class="attr">xmlns:scr</span>=<span class="string">"http://www.osgi.org/xmlns/scr/v1.1.0"</span> <span class="attr">name</span>=<span class="string">"myservice"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">implementation</span> <span class="attr">class</span>=<span class="string">"MyServiceImpl"</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">service</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">provide</span> <span class="attr">interface</span>=<span class="string">"MyService"</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">service</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">component</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>该文件中也可以配置服务引用：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;reference <span class="attribute">bind</span>=<span class="string">"setMyService"</span> <span class="attribute">cardinality</span>=<span class="string">"1..1"</span> <span class="attribute">interface</span>=<span class="string">"MyService"</span> <span class="attribute">name</span>=<span class="string">"myservice"</span> <span class="attribute">policy</span>=<span class="string">"static"</span> <span class="attribute">unbind</span>=<span class="string">"unsetMyService"</span>/&gt;</span><br></pre></td></tr></table></figure>
<p>可以用如下的代码使用所引用的服务：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Method will be used by DS to set the service</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="function"><span class="keyword">void</span> <span class="title">setMyService</span><span class="params">(MyService service)</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"Service was set. Thank you DS!"</span>);</span><br><span class="line">    <span class="keyword">this</span>.service = service;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Method will be used by DS to unset the service</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="function"><span class="keyword">void</span> <span class="title">unsetMyService</span><span class="params">(MyService service)</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"Service was unset."</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.service == service) &#123;</span><br><span class="line">      <span class="keyword">this</span>.service = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="e4中的依赖注入"><a class="markdownIt-Anchor" href="#e4中的依赖注入"></a> e4中的依赖注入</h1>
<p>Declarative Service的方式与Spring的服务组装很类似。但是Spring中已经开始<a href="/2014/01/05/spring_annotations.html">使用注解代替繁琐的XML配置</a>。</p>
<p>从Eclipse e4开始，已经支持使用<a href="/2013/12/31/jsr330.html">JSR330:依赖注入规范</a>实现服务的注入。</p>
<img src="/2014/01/12/dependency_injection_in_e4/e4_inject.png">
<p>在e4增加的服务编程模型中，引入了上下文（context），所有的依赖对象都被上下文管理并通过上下文获取：</p>
<img src="/2014/01/12/dependency_injection_in_e4/e4_context.png">
<p>在Eclipse e4中，将全局的上下文分成了多个层次：</p>
<img src="/2014/01/12/dependency_injection_in_e4/e4_context_hierarchy.png" title="e4上下文的层级">
<p>下层的context可以获取上层context中定义的对象，比如：</p>
<img src="/2014/01/12/dependency_injection_in_e4/e4_context_hierarchy_example.png" title="获取上层context的对象">
<p>e4中，可以使用<a href="/2013/12/31/jsr330.html#menuIndex3">JSR330中基本的<code>@Inject</code>、<code>@Named</code>等注解</a>,用于构造器、方法和属性。同时,e4在<code>org.eclipse.e4.core.di.annotations</code>包中也定义了一些扩展的注解，包括：</p>
<ul>
<li><code>@Optional</code>：声明一个注入(<code>@Inject</code>)为可选</li>
<li><code>@GroupUpdates</code>：声明一个注入的对象是批量更新的，使用这个注解对于RCP应用的性能有很大好处</li>
<li><code>@Execute</code></li>
<li><code>@CanExecute</code></li>
<li><code>@Creatable</code></li>
</ul>
<p>下面是e4中依赖注入的一些例子：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Tracks the active part</span></span><br><span class="line"><span class="variable">@Inject</span></span><br><span class="line"><span class="variable">@Optional</span></span><br><span class="line">public void receiveActivePart(<span class="variable">@Named</span>(IServiceConstants.ACTIVE_PART) MPart activePart) &#123;</span><br><span class="line">  <span class="selector-tag">if</span> (activePart != null) &#123;</span><br><span class="line">  <span class="selector-tag">System</span><span class="selector-class">.out</span><span class="selector-class">.println</span>(<span class="string">"Active part changed "</span></span><br><span class="line">    + activePart.getLabel());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// tracks the active shell</span></span><br><span class="line">@<span class="selector-tag">Inject</span></span><br><span class="line">@<span class="selector-tag">Optional</span></span><br><span class="line"><span class="selector-tag">public</span> <span class="selector-tag">void</span> <span class="selector-tag">receiveActiveShell</span>(<span class="variable">@Named</span>(IServiceConstants.ACTIVE_SHELL) Shell shell) &#123;</span><br><span class="line">  <span class="selector-tag">if</span> (shell != null) &#123;</span><br><span class="line">    <span class="selector-tag">System</span><span class="selector-class">.out</span><span class="selector-class">.println</span>(<span class="string">"Active shell (Window) changed"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>org.eclipse.e4.core.contexts</code>包中定义的<code>@Active</code>注解可以获取活动(actived)组件。比如：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyOwnClass</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Inject</span></span><br><span class="line">  void setChildValue(<span class="meta">@Optional</span> <span class="meta">@Named(<span class="meta-string">"key_of_child_value"</span>)</span> <span class="meta">@Active</span> String value) &#123;</span><br><span class="line">    <span class="keyword">this</span>.childValue = value;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="创建自己的可注入对象"><a class="markdownIt-Anchor" href="#创建自己的可注入对象"></a> 创建自己的可注入对象</h1>
<p><code>@Creatable</code></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://holbrook.github.io/2014/01/08/build_osgi_bundle_with_tycho_maven_plugin.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Holbrook">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="心内求法">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014/01/08/build_osgi_bundle_with_tycho_maven_plugin.html" itemprop="url">Tycho：用Maven构建Eclipse Plugin项目</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-01-08T00:00:00+08:00">
                2014-01-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/软件技术/" itemprop="url" rel="index">
                    <span itemprop="name">软件技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2014/01/08/build_osgi_bundle_with_tycho_maven_plugin.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2014/01/08/build_osgi_bundle_with_tycho_maven_plugin.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Tycho以一组maven插件的形式，支持Eclipse的plug-ins, features, update sites (based on p2) 、products等类型工程的构建。</p>
<p><a href="http://www.sonatype.org/tycho" target="_blank" rel="noopener">Tycho</a>是一个Maven插件，目标是使用Maven构建Eclipse插件，OSGI Bundle等工程。</p>
<p>如果说<a href="http://maven.apache.org/" target="_blank" rel="noopener">Maven</a>的出现是一群Java程序员受不了繁琐的插件依赖管理，受不了冗长的ant build.xml文件而创造出来的，<br>
那Tycho则是一群Eclipse、OSGi插件开发人员受不了重复地配置类似的Maven pom.xml而创造出来的。</p>
<p>Tycho以一组maven插件的形式，支持Eclipse的plug-ins, features, update sites (based on p2) 、products等类型的工程，<br>
表现为不同的maven打包类型(packaging):</p>
<ul>
<li>eclipse-plugin</li>
<li>eclipse-feature</li>
<li>eclipse-test-plugin</li>
<li>eclipse-repository</li>
<li>eclipse-target-definition</li>
</ul>
<h1 id="父工程"><a class="markdownIt-Anchor" href="#父工程"></a> 父工程</h1>
<p>基于OSGi的工程通常会划分很多模块，对于Maven来说，一般通过一个父工程（parent）来管理所有模块的构建。父工程的<code>packaging</code>类型为<code>pom</code>.</p>
<p>为了使用Tycho，需要在父工程的pom文件中增加一些配置。</p>
<h2 id="增加tycho插件"><a class="markdownIt-Anchor" href="#增加tycho插件"></a> 增加Tycho插件</h2>
<p>父工程中定义的插件可以在所有子工程中使用：</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">tycho-version</span>&gt;</span>0.16.0<span class="tag">&lt;/<span class="name">tycho-version</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.eclipse.tycho<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tycho-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>$</span><span class="template-variable">&#123;tycho-version&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">extensions</span>&gt;</span>true<span class="tag">&lt;/<span class="name">extensions</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<h2 id="定义bundle仓库"><a class="markdownIt-Anchor" href="#定义bundle仓库"></a> 定义bundle仓库</h2>
<p>比如，基于Eclipse 4.3(Kepler)的RCP应用，使用了Texo、GeminiJPA等插件，需要如下的仓库定义：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>Kepler<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://download.eclipse.org/releases/kepler<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">layout</span>&gt;</span>p2<span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>Texo<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://download.eclipse.org/modeling/emft/texo/updates/interim<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">layout</span>&gt;</span>p2<span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>GeminiJPA<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://download.eclipse.org/gemini/jpa/updates<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">layout</span>&gt;</span>p2<span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>EclipseLink<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://download.eclipse.org/rt/eclipselink/updates/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">layout</span>&gt;</span>p2<span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="定义目标"><a class="markdownIt-Anchor" href="#定义目标"></a> 定义目标</h2>
<p>定义不同的目标平台：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.eclipse.tycho<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>target-platform-configuration<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">environments</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">environment</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">os</span>&gt;</span>linux<span class="tag">&lt;/<span class="name">os</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ws</span>&gt;</span>gtk<span class="tag">&lt;/<span class="name">ws</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">arch</span>&gt;</span>x86<span class="tag">&lt;/<span class="name">arch</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">environment</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">environment</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">os</span>&gt;</span>macosx<span class="tag">&lt;/<span class="name">os</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ws</span>&gt;</span>cocoa<span class="tag">&lt;/<span class="name">ws</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">arch</span>&gt;</span>x86_64<span class="tag">&lt;/<span class="name">arch</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">environment</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">environments</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>如果要发布比较复杂的目标，比如Eclipse Product的发布，需要单独构建<code>eclipse-target-definition</code>类型的子工程。</p>
<h1 id="为现有工程生成pom"><a class="markdownIt-Anchor" href="#为现有工程生成pom"></a> 为现有工程生成pom</h1>
<p>Tycho提供了一个工具，可以为现有的Eclipse Plugin、Feature等工程生成pom文件，从而将其整合到Tycho的管理之下。</p>
<p>该工具也是基于maven的，只需要在工程文件夹执行命令：</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn org<span class="variable">.eclipse</span><span class="variable">.tycho</span>:tycho-pomgenerator-plugin:<span class="keyword">generate</span>-poms -DgroupId=thinkinside<span class="variable">.tangle</span></span><br></pre></td></tr></table></figure>
<p>生成的pom文件举例如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span> <span class="attr">xmlns</span>=<span class="string">"  http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>thinkinside.tangle<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tangle-app<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>eclipse-plugin<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>由于种种原因，Eclipse Plugin工程的配置内容分散在多个文件中，包括：</p>
<ul>
<li>OSGi的配置文件：MANIFEST.MF</li>
<li>插件工程构建文件：build.properties</li>
<li>插件定义文件：plugin.xml</li>
<li>产品描述文件：.product</li>
</ul>
<p>这些文件中的配置项有重复，开发人员要保证各文件中的相关配置的一致性。</p>
<p>Tycho在生成pom文件时，会检查这些配置文件，将其中的配置项写入pom文件中。</p>
<p>Tycho的逻辑是以上述标准的配置文件优先。比如，在pom文件中没有定义依赖关系，而是以<code>MANIFEST.MF</code>中定义的依赖为准。</p>
<p>如果现有工程已经有了pom文件，还可以使用Tycho进行更新：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn org<span class="selector-class">.eclipse</span><span class="selector-class">.tycho</span>:tycho-versions-plugin:update-pom -Dtycho.mode=maven</span><br></pre></td></tr></table></figure>
<h1 id="目标定义子工程"><a class="markdownIt-Anchor" href="#目标定义子工程"></a> &quot;目标定义&quot;子工程</h1>
<p>前面提到，如果要发布比较复杂的目标，比如Eclipse Product的发布，需要单独构建<code>eclipse-target-definition</code>类型的子工程。</p>
<p>在&quot;目标定义&quot;子工程中创建<code>.product</code>文件，然后在pom文件中添加：</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.eclipse.tycho<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tycho-p2-director-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>$</span><span class="template-variable">&#123;tycho-version&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="comment">&lt;!-- install the product for all configured os/ws/arch environments</span></span></span><br><span class="line"><span class="xml">            using p2 director --&gt;</span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">id</span>&gt;</span>materialize-products<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>materialize-products<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="comment">&lt;!-- (optional) create product zips (one per os/ws/arch) --&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">id</span>&gt;</span>archive-products<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>archive-products<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>&quot;目标定义&quot;子工程中还可以使用”目标定义文件（Target Definition, *.target）“进行复杂的配置。<br>
可以参考<a href="http://wiki.eclipse.org/Tycho/Target_Platform" target="_blank" rel="noopener">这里</a>的说明，也可以查看<a href="https://github.com/toedter/e4-tutorial" target="_blank" rel="noopener">GitHub上的例子</a>的例子。</p>
<h1 id="test工程"><a class="markdownIt-Anchor" href="#test工程"></a> Test工程</h1>
<p>与专门的测试工具<a href="">Pax Exam</a>相比，Tycho test使用起来会更简单。当然前提是测试由Tycho构建的OSGi应用。</p>
<p>Tycho将一个&quot;Fragment&quot;工程包装成Maven工程，可以在其中编写测试代码，然后使用&quot;JUnit Plug-in Test&quot;执行测试。</p>
<h1 id="对比maven-bundle-plugin"><a class="markdownIt-Anchor" href="#对比maven-bundle-plugin"></a> 对比Maven-Bundle-Plugin</h1>
<p>Maven-Bundle-Plugin提供了与Tycho不同风格的另一种构建OSGi的maven插件。关于二者的对比，可以参考<a href="/2014/01/21/tycho_vs_maven_bundle_plugin.html">这里</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/5/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><a class="extend next" rel="next" href="/page/7/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Holbrook</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">125</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">70</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Holbrook</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://.disqus.com/count.js" async></script>
    

    

  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
